<!DOCTYPE html><html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Super Earnings Pace â€” Dashboard + Yearly Insights</title>

  <!-- Arabic font for flawless RTL rendering -->
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0a0a0a; --surface:#0f0f0f; --muted:#9a9a9a; --text:#f6f6f6; --line:#1e1e1e; --accent:#ebebeb; --chip:#151515;
      --tooltip:#111; --tooltipBorder:#2a2a2a; --sp:14px; --sp-lg:18px;
      --c1:#7dd3fc; --c2:#a7f3d0; --c3:#fca5a5; --c4:#fde68a; --c5:#c4b5fd; --c6:#f9a8d4; --c7:#93c5fd; --c8:#6ee7b7; --c9:#fcd34d; --c10:#fdba74;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text)}
    /* font stacks */
    html:not(.rtl) body{font-family:Inter,ui-sans-serif,-apple-system,Segoe UI,Roboto,system-ui,sans-serif;}
    html.rtl body{
      font-family:"IBM Plex Sans Arabic", system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      line-height:1.6; -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }
    html.rtl *{letter-spacing:0 !important; text-transform:none;}
    .wrap{max-width:1180px;margin:0 auto;padding:20px;display:grid;gap:var(--sp-lg)}
    .head{display:flex;gap:12px;align-items:center}
    .title{font-size:18px;font-weight:800}
    .hint{color:var(--muted);font-size:13px}
    .chip{padding:8px 10px;background:var(--chip);border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:12px}
    .right{margin-left:auto} /* keep header layout stable even in RTL */

    #langToggle{padding:10px 12px;border-radius:999px;border:1px solid var(--line);background:#0c0c0c;color:#f6f6f6;font-weight:800;cursor:pointer}

    .tabs{display:flex;gap:8px;align-items:center;position:sticky;top:0;z-index:2}
    .tabbtn{padding:10px 14px;border:1px solid var(--line);border-radius:999px;background:#0c0c0c;color:#f6f6f6;cursor:pointer;font-weight:700;transition:transform .12s ease}
    .tabbtn:hover{transform:translateY(-1px)}
    .tabbtn.active{background:var(--accent);color:#000;box-shadow:0 0 0 2px #000 inset}
    .tabspace{background:rgba(10,10,10,.92);border:1px solid var(--line);border-radius:14px;padding:16px;margin-top:6px}

    .dock{background:rgba(10,10,10,.92);border:1px solid var(--line);border-radius:14px;padding:16px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:var(--sp)}
    .c-2{grid-column:span 2}.c-3{grid-column:span 3}.c-4{grid-column:span 4}.c-5{grid-column:span 5}.c-6{grid-column:span 6}.c-7{grid-column:span 7}.c-8{grid-column:span 8}.c-12{grid-column:span 12}
    @media (max-width:900px){.c-8,.c-7,.c-6,.c-5,.c-4,.c-3,.c-2,.c-12{grid-column:span 12}.grid{gap:16px}}
    label{font-size:11px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,button{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:#0b0b0b;color:#f6f6f6}
    .btn{background:var(--accent);color:#000;border:none;font-weight:700;cursor:pointer}
    .btn:active{transform:translateY(1px)}

    .cards{display:grid;grid-template-columns:repeat(6,1fr);gap:var(--sp)}
    @media (max-width:1120px){.cards{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:650px){.cards{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:420px){.cards{grid-template-columns:1fr}}
    .card{background:var(--surface);border:1px solid var(--line);border-radius:16px;padding:16px}
    .k{font-size:10px;letter-spacing:.14em;color:var(--muted);text-transform:uppercase}
    html.rtl .k{letter-spacing:0}
    .v{font-size:24px;font-weight:800;margin-top:6px}

    .section{background:var(--surface);border:1px solid var(--line);border-radius:16px;padding:16px;margin-top:var(--sp)}
    .section h2{margin:0 0 8px;font-size:12px;letter-spacing:.12em;color:var(--muted);text-transform:uppercase}
    .bar{height:10px;border:1px solid var(--line);border-radius:10px;background:#121212;overflow:hidden}
    .bar span{display:block;height:100%;width:0;background:var(--accent);transition:width .3s ease}

    .facts{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--sp)}
    @media (max-width:900px){.facts{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:600px){.facts{grid-template-columns:1fr}}
    .fact{background:var(--surface);border:1px solid var(--line);border-radius:14px;padding:12px}
    .fact .t{font-weight:700}
    .fact .d{color:var(--muted);font-size:13px;margin-top:2px}

    .other-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:var(--sp)}
    @media (max-width:900px){.other-grid{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:600px){.other-grid{grid-template-columns:repeat(2,1fr)}}
    .other{background:var(--surface);border:1px solid var(--line);border-radius:12px;padding:12px}
    .other .c{font-size:11px;color:var(--muted)}
    .other .n{font-size:16px;font-weight:700;margin-top:4px}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center}
    .modal.open{display:flex}
    .modal-content{width:min(720px,92vw);background:#0c0c0c;border:1px solid var(--line);border-radius:16px;padding:16px}
    .modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .row{display:grid;grid-template-columns:repeat(5,1fr);gap:var(--sp)}

    canvas{width:100%;height:280px;border:1px solid var(--line);border-radius:12px;background:#0b0b0b;image-rendering:crisp-edges}
    .mini{height:200px}

    .tt{position:fixed;pointer-events:none;background:var(--tooltip);border:1px solid var(--tooltipBorder);padding:8px 10px;border-radius:10px;color:#eee;font-size:12px;transform:translate(-50%,-120%);display:none;white-space:nowrap}

    /* RTL basics */
    html.rtl{direction:rtl}
    html.rtl .tabs{flex-direction:row-reverse}
    html.rtl .grid{direction:rtl}
    html.rtl label, html.rtl .k, html.rtl .hint, html.rtl .t, html.rtl .d {text-align:right}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="head">
      <div class="title" id="t_title">Super Earnings Pace</div>
      <div class="hint" id="t_sub">Manual rates Â· clean pace Â· smart + fun facts</div>
      <span class="right"></span>
      <button id="langToggle" class="chip">Ø¹Ø±Ø¨ÙŠ / EN</button>
    </div>

    <div class="tabs">
      <button class="tabbtn active" id="tabDash">Dashboard</button>
      <button class="tabbtn" id="tabInsights">Insights Lab</button>
    </div>

    <!-- DASHBOARD -->
    <div class="tabspace" id="panelDash">
      <div class="dock">
        <div class="grid">
          <div class="c-4">
            <label id="t_total_label">Total earned to date</label>
            <input id="total" type="number" min="0" step="0.01" placeholder="12500.00"/>
          </div>
          <div class="c-3">
            <label id="t_incur">Input currency</label>
            <select id="inCur"></select>
          </div>
          <div class="c-3">
            <label id="t_outcur">Display currency</label>
            <select id="outCur"></select>
          </div>
          <div class="c-2"><label>&nbsp;</label><button class="btn" id="openRates">Rates</button></div>
        </div>
      </div>

      <div class="cards">
        <div class="card"><div class="k" id="t_persec">Per second</div><div class="v" id="perSec">0.00</div></div>
        <div class="card"><div class="k" id="t_permin">Per minute</div><div class="v" id="perMin">0.00</div></div>
        <div class="card"><div class="k" id="t_perhr">Per hour</div><div class="v" id="perHr">0.00</div></div>
        <div class="card"><div class="k" id="t_perday">Per day</div><div class="v" id="perDay">0.00</div></div>
        <div class="card"><div class="k" id="t_perwk">Per week</div><div class="v" id="perWk">0.00</div></div>
        <div class="card"><div class="k" id="t_permon">Per month (avg)</div><div class="v" id="perMon">0.00</div></div>
      </div>

      <div class="section">
        <h2 id="t_yearprog">Year progress</h2>
        <div style="display:flex;gap:12px;align-items:center">
          <div class="bar" style="flex:1"><span id="yBar"></span></div>
          <span class="chip" id="yPct">0%</span>
          <span class="chip" id="elapsedLabel">day 0 of 365</span>
        </div>
      </div>

      <div class="section">
        <h2 id="t_othercurr">Earned until now â€” other currencies</h2>
        <div class="other-grid" id="otherList"></div>
      </div>

      <div class="section">
        <h2 id="t_smartfacts">Smart facts</h2>
        <div class="facts">
          <div class="fact"><div class="t" id="t_proj">Projected year total</div><div class="d" id="proj"></div></div>
          <div class="fact"><div class="t" id="t_sincemid">Earned since midnight</div><div class="d" id="sinceDay"></div></div>
          <div class="fact"><div class="t" id="t_sinceweek">Earned this week</div><div class="d" id="sinceWeek"></div></div>
          <div class="fact"><div class="t" id="t_sincemonth">Earned this month</div><div class="d" id="sinceMonth"></div></div>
        </div>
      </div>

      <details>
        <summary id="t_funfacts">Show fun facts ğŸˆ</summary>
        <div class="facts">
          <div class="fact"><div class="t" id="t_match">Per football match (90m)</div><div class="d" id="perMatch"></div></div>
          <div class="fact"><div class="t" id="t_episode">Per Netflix episode (45m)</div><div class="d" id="perEpisode"></div></div>
          <div class="fact"><div class="t" id="t_coffee">Per coffee run (7m)</div><div class="d" id="perCoffee"></div></div>
          <div class="fact"><div class="t" id="t_shower">Per shower (8m)</div><div class="d" id="perShower"></div></div>
          <div class="fact"><div class="t" id="t_song">Per song (3m30s)</div><div class="d" id="perSong"></div></div>
          <div class="fact"><div class="t" id="t_penalty">Penalty shootout (5m)</div><div class="d" id="perPenalty"></div></div>
          <div class="fact"><div class="t" id="t_traffic">Traffic light cycle (90s)</div><div class="d" id="perTraffic"></div></div>
          <div class="fact"><div class="t" id="t_espresso">Espresso shot pull (30s)</div><div class="d" id="perEspresso"></div></div>
          <div class="fact"><div class="t" id="t_diaper">Diaper change (2m)</div><div class="d" id="perDiaper"></div></div>
          <div class="fact"><div class="t" id="t_voice">WhatsApp voice note (1m)</div><div class="d" id="perVoice"></div></div>
          <div class="fact"><div class="t" id="t_micro">Microwave dinner (3m)</div><div class="d" id="perMicrowave"></div></div>
          <div class="fact"><div class="t" id="t_brush">Toothbrushing (2m30s)</div><div class="d" id="perBrush"></div></div>
        </div>
      </details>
    </div>

    <!-- INSIGHTS -->
    <div class="tabspace" id="panelInsights" style="display:none">
      <div class="dock">
        <div class="grid">
          <div class="c-2">
            <label id="t_incur_ins">Input currency</label>
            <select id="inCurInsights"></select>
          </div>
          <div class="c-2">
            <label id="t_outcur_ins">Display currency</label>
            <select id="outCurInsights"></select>
          </div>

          <!-- EGP Historical Adjustment (local, no API) -->
          <div class="c-4">
            <label id="t_egpadj_label">ØªØ¹Ø¯ÙŠÙ„ ØªØ§Ø±ÙŠØ®ÙŠ Ù„Ù„Ø¬Ù†ÙŠÙ‡ (USD/EGP)</label>
            <div style="display:flex;gap:8px;align-items:center">
              <label class="chip" style="display:flex;align-items:center;gap:8px">
                <input id="egpAdjToggle" type="checkbox" style="width:auto"> <span id="t_egpadj_on">Ø´ØºÙ‘Ø§Ù„</span>
              </label>
              <button class="btn" id="openEgpHist"><span id="t_egp_table_btn">Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø³Ù†ÙŠÙ†</span></button>
            </div>
            <small class="hint" id="t_egp_hint">Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø© Ø¨ØªØ­ÙˆÙ‘Ù„ Ø¬Ù†ÙŠÙ‡ ÙƒÙ„ Ø³Ù†Ø© Ù„Ø¯ÙˆÙ„Ø§Ø± Ø¨Ø³Ø¹Ø±Ù‡Ø§ ÙˆÙ‚ØªÙ‡Ø§.. ÙˆØªØ±Ø¬Ù‘Ø¹Ù‡ Ù„Ø¬Ù†ÙŠÙ‡ Ø¨Ù‚ÙŠÙ…Ø© Ø§Ù„Ù†Ù‡Ø§Ø±Ø¯Ù‡.. ÙˆØ¨Ø¹Ø¯ÙŠÙ† ØªØ¹Ø±Ø¶ Ø¨Ø¹Ù…Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶.</small>
          </div>

          <div class="c-6">
            <label id="t_yearlytot">Yearly totals</label>
            <div id="yearsTable"></div>
          </div>
          <div class="c-1"><label>&nbsp;</label><button class="btn" id="addRow">+ Add</button></div>
          <div class="c-1"><label>&nbsp;</label><button class="btn" id="loadSample">Sample</button></div>

          <div class="c-12">
            <small class="hint" id="t_dataset_hint">Dataset uses the Input currency. All metrics/charts auto-convert to Display currency.</small>
          </div>
        </div>
      </div>

      <div class="cards">
        <div class="card"><div class="k" id="t_yearscovered">Years covered</div><div class="v" id="yYears">â€”</div></div>
        <div class="card"><div class="k" id="t_totalall">Total (all years)</div><div class="v" id="yTotal">â€”</div></div>
        <div class="card"><div class="k" id="t_avgyear">Average / year</div><div class="v" id="yAvg">â€”</div></div>
        <div class="card"><div class="k" id="t_median">Median / year</div><div class="v" id="yMedian">â€”</div></div>
        <div class="card"><div class="k" id="t_bestyear">Best year</div><div class="v" id="yBest">â€”</div></div>
        <div class="card"><div class="k" id="t_worstyear">Worst year</div><div class="v" id="yWorst">â€”</div></div>
        <div class="card"><div class="k" id="t_cagr">CAGR</div><div class="v" id="yCAGR">â€”</div></div>
        <div class="card"><div class="k" id="t_cv">Volatility (Ïƒ/avg)</div><div class="v" id="yCV">â€”</div></div>
        <div class="card"><div class="k" id="t_hit">Growth hit-rate</div><div class="v" id="yHit">â€”</div></div>
        <div class="card"><div class="k" id="t_mdd">Max drawdown</div><div class="v" id="yMDD">â€”</div></div>
        <div class="card"><div class="k" id="t_lastvsavg">Last vs avg</div><div class="v" id="yLastVsAvg">â€”</div></div>
        <div class="card"><div class="k" id="t_lastyoy">Last YoY growth</div><div class="v" id="yLastYoY">â€”</div></div>
      </div>

      <div class="section">
        <h2 id="t_charts">Charts</h2>
        <div class="grid">
          <div class="c-6"><label id="t_c_yline">Yearly totals</label><canvas id="chartYLine"></canvas><small class="hint" id="t_c_yline_hint">Line chart of yearly totals in Display currency. Hover for details.</small></div>
          <div class="c-6"><label id="t_c_yoy">YoY growth %</label><canvas id="chartYoY"></canvas><small class="hint" id="t_c_yoy_hint">Bar chart of year-over-year growth (percentage). Hover to see exact %.</small></div>
          <div class="c-6"><label id="t_c_cum">Cumulative total</label><canvas id="chartYCum" class="mini"></canvas><small class="hint" id="t_c_cum_hint">Sum of all years up to each point. Shows compounding progress.</small></div>
          <div class="c-6"><label id="t_c_roll">Rolling 3-yr average</label><canvas id="chartRoll" class="mini"></canvas><small class="hint" id="t_c_roll_hint">Smoother trend line using last 3 years' average.</small></div>
          <div class="c-6"><label id="t_c_hist">Histogram</label><canvas id="chartHist" class="mini"></canvas><small class="hint" id="t_c_hist_hint">Distribution of yearly totals (how values cluster).</small></div>
          <div class="c-6"><label id="t_c_pie">Top-5 share</label><canvas id="chartPie" class="mini"></canvas><small class="hint" id="t_c_pie_hint">Top 5 years vs the rest.</small></div>
          <div class="c-6"><label id="t_c_dd">Drawdown</label><canvas id="chartDD" class="mini"></canvas><small class="hint" id="t_c_dd_hint">Drop from prior peak, % (risk view).</small></div>
          <div class="c-6"><label id="t_c_vol">Rolling volatility</label><canvas id="chartVol" class="mini"></canvas><small class="hint" id="t_c_vol_hint">Std dev of last 3 years (stability).</small></div>
          <div class="c-6"><label id="t_c_scatter">Growth scatter</label><canvas id="chartScatter" class="mini"></canvas><small class="hint" id="t_c_scatter_hint">Year vs growth %. Closer to top = stronger growth.</small></div>
          <div class="c-6"><label id="t_c_lastvs">Last vs avg bar</label><canvas id="chartLastVs" class="mini"></canvas><small class="hint" id="t_c_lastvs_hint">How the latest year compares to historical average.</small></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tooltip -->
  <div class="tt" id="tooltip"></div>

  <!-- Rates modal -->
  <div class="modal" id="ratesModal">
    <div class="modal-content" role="dialog" aria-labelledby="ratesTitle">
      <div class="modal-header">
        <h3 id="ratesTitle">Currency rates (base USD = 1.00)</h3>
      </div>
      <div class="row">
        <div><label>USD</label><input id="usdRate" type="number" step="0.01" value="1.00" readonly></div>
        <div><label>EGP</label><input id="egpRate" type="number" step="0.01" value="50.00"></div>
        <div><label>SAR</label><input id="sarRate" type="number" step="0.01" value="3.75"></div>
        <div><label>KWD</label><input id="kwdRate" type="number" step="0.01" value="0.30"></div>
        <div><label>AED</label><input id="aedRate" type="number" step="0.01" value="3.67"></div>
        <div><label>EUR</label><input id="eurRate" type="number" step="0.01" value="0.92"></div>
        <div><label>GBP</label><input id="gbpRate" type="number" step="0.01" value="0.78"></div>
        <div><label>QAR</label><input id="qarRate" type="number" step="0.01" value="3.64"></div>
        <div><label>OMR</label><input id="omrRate" type="number" step="0.001" value="0.384"></div>
        <div><label>BHD</label><input id="bhdRate" type="number" step="0.001" value="0.376"></div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button class="btn" id="cancelRates">Close</button>
        <button class="btn" id="saveRates">Save</button>
      </div>
    </div>
  </div>

  <!-- Local historical USD/EGP editor -->
  <div class="modal" id="egpHistModal">
    <div class="modal-content" role="dialog" aria-labelledby="egpHistTitle">
      <div class="modal-header">
        <h3 id="egpHistTitle">USD/EGP â€” Ù…ØªÙˆØ³Ø· Ø³Ù†ÙˆÙŠ (Ù„ÙˆÙƒØ§Ù„)</h3>
      </div>
      <div id="egpHistTable" style="max-height:50vh;overflow:auto;margin-bottom:10px"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="btn" id="egpClose">Ø¥ØºÙ„Ø§Ù‚</button>
        <button class="btn" id="egpSave">Ø­ÙØ¸</button>
      </div>
    </div>
  </div>

<script>
/* ---------- helpers / state ---------- */
const $=(id)=>document.getElementById(id);
const CURRENCIES=['USD','EGP','SAR','KWD','AED','EUR','GBP','QAR','OMR','BHD'];
const PAL=['#7dd3fc','#a7f3d0','#fca5a5','#fde68a','#c4b5fd','#f9a8d4','#93c5fd','#6ee7b7','#fcd34d','#fdba74'];
const fmt=(n)=>((+n)||0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
let exchangeRates={USD:1.00,EGP:50.00,SAR:3.75,KWD:0.30,AED:3.67,EUR:0.92,GBP:0.78,QAR:3.64,OMR:0.384,BHD:0.376};
const stateKey='super_earnings_tabs_v6';
let years=[]; let currentOutC='USD';

/* Local historical USD/EGP averages (Year -> EGP per 1 USD)
   NOTE: Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…Ù† ÙˆØ§Ø¬Ù‡Ø© "Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø³Ù†ÙŠÙ†".
   Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø£Ø¯Ù†Ø§Ù‡ Ù…ØªÙˆØ³Ø·Ø§Øª Ø³Ù†ÙˆÙŠØ© ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§ (WB/IMF) Ø­ØªÙ‰ 2023.. Ùˆ2024-2025 Ù…Ø­Ø¯Ø«Ø© Ø¨Ù‚ÙŠÙ…Ø© Ø³ÙˆÙ‚ Ù‚Ø±ÙŠØ¨Ø©.
*/
let egpUsdHistory={
  2000:3.47,2001:3.88,2002:4.50,2003:6.20,2004:6.10,2005:5.78,2006:5.72,2007:5.64,2008:5.44,2009:5.55,
  2010:5.69,2011:5.93,2012:6.18,2013:6.87,2014:7.15,2015:7.75,2016:10.00,2017:17.80,2018:17.70,2019:16.80,
  2020:15.75,2021:15.70,2022:18.80,2023:30.00,2024:48.00,2025:48.00
};
let egpAdjustOn=false;

/* i18n */
const i18n={
  en:{
    tabDash:'Dashboard', tabInsights:'Insights Lab',
    t_total_label:'Total earned to date', t_incur:'Input currency', t_outcur:'Display currency', btnRates:'Rates',
    t_persec:'Per second', t_permin:'Per minute', t_perhr:'Per hour', t_perday:'Per day', t_perwk:'Per week', t_permon:'Per month (avg)',
    t_yearprog:'Year progress', t_othercurr:'Earned until now â€” other currencies',
    t_smartfacts:'Smart facts', t_proj:'Projected year total', t_sincemid:'Earned since midnight', t_sinceweek:'Earned this week', t_sincemonth:'Earned this month',
    t_funfacts:'Show fun facts ğŸˆ',
    t_incur_ins:'Input currency', t_outcur_ins:'Display currency', t_yearlytot:'Yearly totals', t_dataset_hint:'Dataset uses the Input currency. All metrics/charts auto-convert to Display currency.',
    t_yearscovered:'Years covered', t_totalall:'Total (all years)', t_avgyear:'Average / year', t_median:'Median / year', t_bestyear:'Best year', t_worstyear:'Worst year', t_cagr:'CAGR', t_cv:'Volatility (Ïƒ/avg)', t_hit:'Growth hit-rate', t_mdd:'Max drawdown', t_lastvsavg:'Last vs avg', t_lastyoy:'Last YoY growth',
    t_charts:'Charts', t_c_yline:'Yearly totals', t_c_yline_hint:'Line chart of yearly totals in Display currency. Hover for details.', t_c_yoy:'YoY growth %', t_c_yoy_hint:'Bar chart of year-over-year growth (percentage). Hover to see exact %.', t_c_cum:'Cumulative total', t_c_cum_hint:'Sum of all years up to each point. Shows compounding progress.', t_c_roll:'Rolling 3-yr average', t_c_roll_hint:'Smoother trend line using last 3 years\' average.', t_c_hist:'Histogram', t_c_hist_hint:'Distribution of yearly totals.', t_c_pie:'Top-5 share', t_c_pie_hint:'Top 5 years vs the rest.', t_c_dd:'Drawdown', t_c_dd_hint:'Drop from prior peak, % (risk view).', t_c_vol:'Rolling volatility', t_c_vol_hint:'Std dev of last 3 years (stability).', t_c_scatter:'Growth scatter', t_c_scatter_hint:'Year vs growth %. Closer to top = stronger growth.', t_c_lastvs:'Last vs avg bar', t_c_lastvs_hint:'How the latest year compares to historical average.',
    ratesTitle:'Currency rates (base USD = 1.00)', btnClose:'Close', btnSave:'Save', btnAdd:'+ Add', btnSample:'Sample'
  },
  ar:{
    tabDash:'Ø§Ù„Ù„ÙˆØ­Ø©', tabInsights:'Ù…Ø¹Ù…Ù„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª',
    t_total_label:'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ø­Ø¯ Ø¯Ù„ÙˆÙ‚ØªÙŠ', t_incur:'Ø¹Ù…Ù„Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„', t_outcur:'Ø¹Ù…Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶', btnRates:'Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ØµØ±Ù',
    t_persec:'ÙÙŠ Ø§Ù„Ø«Ø§Ù†ÙŠØ©', t_permin:'ÙÙŠ Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©', t_perhr:'ÙÙŠ Ø§Ù„Ø³Ø§Ø¹Ø©', t_perday:'ÙÙŠ Ø§Ù„ÙŠÙˆÙ…', t_perwk:'ÙÙŠ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹', t_permon:'ÙÙŠ Ø§Ù„Ø´Ù‡Ø± (Ù…ØªÙˆØ³Ø·)',
    t_yearprog:'ØªÙ‚Ø¯Ù‘Ù… Ø§Ù„Ø³Ù†Ø©', t_othercurr:'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ø­Ø¯ Ø¯Ù„ÙˆÙ‚ØªÙŠ â€” Ø¹Ù…Ù„Ø§Øª ØªØ§Ù†ÙŠØ©',
    t_smartfacts:'Ø£Ø±Ù‚Ø§Ù… Ø³Ø±ÙŠØ¹Ø©', t_proj:'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…ØªÙˆÙ‚Ù‘Ø¹ Ø¢Ø®Ø± Ø§Ù„Ø³Ù†Ø©', t_sincemid:'Ù…Ù† Ø¨Ø¹Ø¯ Ù†Øµ Ø§Ù„Ù„ÙŠÙ„', t_sinceweek:'Ù…Ù† Ø£ÙˆÙ„ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹', t_sincemonth:'Ù…Ù† Ø£ÙˆÙ„ Ø§Ù„Ø´Ù‡Ø±',
    t_funfacts:'Ø§Ø¹Ø±Ø¶ Ø­Ø§Ø¬Ø§Øª Ù„Ø·ÙŠÙØ© ğŸˆ',
    t_incur_ins:'Ø¹Ù…Ù„Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„', t_outcur_ins:'Ø¹Ù…Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶', t_yearlytot:'Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø³Ù†ÙˆÙŠØ©', t_dataset_hint:'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ù…Ù„Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„.. ÙˆØ§Ù„Ø±Ø³ÙˆÙ… Ø¨ØªØªØ­ÙˆÙ‘Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶.',
    t_yearscovered:'Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ù†ÙŠÙ†', t_totalall:'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (ÙƒÙ„ Ø§Ù„Ø³Ù†ÙŠÙ†)', t_avgyear:'Ù…ØªÙˆØ³Ø·/Ø³Ù†Ø©', t_median:'Ø§Ù„ÙˆØ³ÙŠØ·/Ø³Ù†Ø©', t_bestyear:'Ø£Ø¹Ù„Ù‰ Ø³Ù†Ø©', t_worstyear:'Ø£Ù‚Ù„ Ø³Ù†Ø©', t_cagr:'Ù…Ø¹Ø¯Ù„ Ù†Ù…Ùˆ Ù…Ø±ÙƒÙ‘Ø¨', t_cv:'ØªØ°Ø¨Ø°Ø¨ (Ïƒ/Ù…ØªÙˆØ³Ø·)', t_hit:'Ø³Ù†ÙŠÙ† Ø§Ù„Ù†Ù…Ùˆ', t_mdd:'Ø£Ù‚ØµÙ‰ ØªØ±Ø§Ø¬Ø¹', t_lastvsavg:'Ø¢Ø®Ø± Ø³Ù†Ø© Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ù…ØªÙˆØ³Ø·', t_lastyoy:'Ù†Ù…Ùˆ Ø¢Ø®Ø± Ø³Ù†Ø© Ø¹Ù† Ø§Ù„Ù„ÙŠ Ù‚Ø¨Ù„Ù‡Ø§',
    t_charts:'Ø±Ø³ÙˆÙ… Ø¨ÙŠØ§Ù†ÙŠØ©', t_c_yline:'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ù†ÙˆÙŠ', t_c_yline_hint:'Ø®Ø· Ù„Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø§Ù„Ø³Ù†ÙˆÙŠØ©.. Ù…Ø±Ù‘Ø± Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª.', t_c_yoy:'Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ù…Ùˆ Ø³Ù†Ø© Ù„Ø³Ù†Ø©', t_c_yoy_hint:'Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø¨ØªÙˆØ¶Ø­ Ø§Ù„Ù†Ø³Ø¨Ø©.', t_c_cum:'Ù…Ø¬Ù…ÙˆØ¹ ØªØ±Ø§ÙƒÙ…ÙŠ', t_c_cum_hint:'ØªØ¬Ù…ÙŠØ¹ Ø¹Ø¨Ø± Ø§Ù„Ø³Ù†ÙŠÙ†.', t_c_roll:'Ù…ØªÙˆØ³Ø· Ù£ Ø³Ù†ÙŠÙ† Ù…ØªØ­Ø±Ùƒ', t_c_roll_hint:'Ù…ØªÙˆØ³Ø· Ø¢Ø®Ø± Ù£ Ø³Ù†ÙŠÙ†.', t_c_hist:'ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù‚ÙŠÙ…', t_c_hist_hint:'Ø§Ù„Ù‚ÙŠÙ… Ø¨ØªØªØ¬Ù…Ø¹ ÙÙŠÙ†.', t_c_pie:'Ø£Ø¹Ù„Ù‰ Ù¥ Ø³Ù†ÙŠÙ†', t_c_pie_hint:'Ø£Ø¹Ù„Ù‰ Ø®Ù…Ø³ Ø³Ù†ÙŠÙ† Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ø¨Ø§Ù‚ÙŠ.', t_c_dd:'ØªØ±Ø§Ø¬Ø¹ Ù…Ù† Ø§Ù„Ù‚Ù…Ø©', t_c_dd_hint:'Ù†Ø²ÙˆÙ„ Ø¹Ù† Ø£Ø¹Ù„Ù‰ Ù‚ÙŠÙ…Ø© %.', t_c_vol:'ØªØ°Ø¨Ø°Ø¨ Ù…ØªØ­Ø±Ùƒ', t_c_vol_hint:'Ø§Ù†Ø­Ø±Ø§Ù Ù…Ø¹ÙŠØ§Ø±ÙŠ (Ù£ Ø³Ù†ÙŠÙ†).', t_c_scatter:'Ù†ÙÙ‚Ø§Ø· Ø§Ù„Ù†Ù…Ùˆ', t_c_scatter_hint:'Ø§Ù„Ø³Ù†Ø© Ù…Ù‚Ø§Ø¨Ù„ Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ù…Ùˆ.', t_c_lastvs:'Ø¢Ø®Ø± Ø³Ù†Ø© vs Ø§Ù„Ù…ØªÙˆØ³Ø·', t_c_lastvs_hint:'Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø© Ø¨Ø§Ù„Ù…ØªÙˆØ³Ø·.',
  }
};
let lang='en';

function applyI18n(){
  const dict=i18n[lang];
  Object.keys(dict).forEach(id=>{
    if(id==='t_title'||id==='t_sub') return; // keep header fixed
    const el=$(id); if(el) el.textContent=dict[id];
  });
  const mapBtn={ openRates:'btnRates', addRow:'btnAdd', loadSample:'btnSample' };
  Object.entries(mapBtn).forEach(([domId,key])=>{ const el=$(domId); if(el && dict[key]) el.textContent=dict[key]; });
  document.documentElement.lang=(lang==='ar'?'ar':'en');
  document.documentElement.classList.toggle('rtl', lang==='ar');
}
function setLang(next){ lang=next; applyI18n(); renderYears(); drawYearInsights(); save(); }

/* persistence */
function save(){
  const s={ total:$('total').value, inCur:$('inCur').value, outCur:$('outCur').value,
    years, rates:exchangeRates, lang, egpUsdHistory, egpAdjustOn };
  localStorage.setItem(stateKey, JSON.stringify(s));
}
function load(){
  const saved=localStorage.getItem(stateKey); if(!saved) return;
  try{ const s=JSON.parse(saved);
    ['total','inCur','outCur'].forEach(k=>{ if(s[k]!==undefined && $(k)) $(k).value=s[k]; });
    if(s.rates) exchangeRates={...exchangeRates,...s.rates};
    if(Array.isArray(s.years)) years=s.years;
    if(s.lang) lang=s.lang;
    if(s.egpUsdHistory) egpUsdHistory=s.egpUsdHistory;
    if(typeof s.egpAdjustOn==='boolean') egpAdjustOn=s.egpAdjustOn;
  }catch(e){}
}

/* currency + conversion */
function convert(amount,from,to){ if(!amount) return 0; const usd=amount/(exchangeRates[from]||1); return usd*(exchangeRates[to]||1); }
function setInputCurrency(cur){ if(CURRENCIES.includes(cur)){ $('inCur').value=cur; $('inCurInsights').value=cur; renderYears(); calc(); drawYearInsights(); save(); } }
function setDisplayCurrency(cur){ if(CURRENCIES.includes(cur)){ $('outCur').value=cur; $('outCurInsights').value=cur; currentOutC=cur; calc(); drawYearInsights(); save(); } }

/* years table */
function renderYears(){
  const wrap=$('yearsTable'); if(!wrap) return; wrap.innerHTML='';
  const table=document.createElement('div'); table.style.display='grid'; table.style.gridTemplateColumns='140px 1fr 100px'; table.style.gap='12px';
  const head=[ lang==='ar'?'Ø§Ù„Ø³Ù†Ø©':'Year', `${i18n[lang].t_totalall} (${($('inCur').value||'USD')})`, '' ];
  head.forEach(t=>{ const h=document.createElement('div'); h.style.color='#9a9a9a'; h.style.fontSize='12px'; h.textContent=t; table.appendChild(h); });
  years.forEach((row,idx)=>{
    const y=document.createElement('input'); y.type='number'; y.value=row.year; y.min=1900; y.max=9999; y.step=1;
    const v=document.createElement('input'); v.type='number'; v.step='0.01'; v.min='0'; v.value=row.value;
    const del=document.createElement('button'); del.className='btn'; del.textContent= lang==='ar'?'Ø­Ø°Ù':'Delete';
    y.addEventListener('input',()=>{ years[idx].year=parseInt(y.value||0,10); drawYearInsights(); save(); });
    v.addEventListener('input',()=>{ years[idx].value=parseFloat(v.value||0); drawYearInsights(); save(); });
    del.addEventListener('click',()=>{ years.splice(idx,1); renderYears(); drawYearInsights(); save(); });
    table.appendChild(y); table.appendChild(v); table.appendChild(del);
  });
  wrap.appendChild(table);
}

/* dashboard calc */
function calc(){
  const totalRaw=parseFloat($('total').value)||0; const inC=$('inCur').value||'USD'; const outC=$('outCur').value||'USD'; currentOutC=outC;
  const now=new Date(); const start=new Date(now.getFullYear(),0,1); start.setHours(0,0,0,0);
  const endYear=new Date(now.getFullYear(),11,31,23,59,59,999);

  const total=convert(totalRaw,inC,outC);

  const elapsedMs=now-start, yearMs=endYear-start; const daysInYear=Math.floor((endYear-start)/86400000)+1;
  const elapsedHours=Math.max(elapsedMs/3600000,1e-9);
  const perHour=total/elapsedHours, perMinute=perHour/60, perSecond=perMinute/60, perDay=perHour*24, perWeek=perDay*7, perMonth=perDay*(daysInYear/12);

  $('perSec').textContent=fmt(perSecond); $('perMin').textContent=fmt(perMinute); $('perHr').textContent=fmt(perHour); $('perDay').textContent=fmt(perDay); $('perWk').textContent=fmt(perWeek); $('perMon').textContent=fmt(perMonth);

  const yearPct=Math.min((elapsedMs/yearMs)*100,100); $('yBar').style.width=yearPct.toFixed(2)+'%'; $('yPct').textContent=yearPct.toFixed(1)+'%';
  const dayNumber=Math.floor((now-start)/86400000)+1; $('elapsedLabel').textContent=(lang==='ar'?`Ø§Ù„ÙŠÙˆÙ… ${dayNumber} Ù…Ù† ${daysInYear}`:`day ${dayNumber} of ${daysInYear}`);

  $('proj').textContent=`${fmt(perHour*(daysInYear*24))} ${outC}`;

  const sinceMidnightHours=(now-new Date(now.getFullYear(),now.getMonth(),now.getDate()))/3600000; $('sinceDay').textContent=`${fmt(perHour*sinceMidnightHours)} ${outC}`;
  const sow=(d=>{ const x=new Date(d); const day=(x.getDay()+6)%7; x.setDate(x.getDate()-day); x.setHours(0,0,0,0); return x; })(now);
  const hoursWeek=(now-sow)/3600000; $('sinceWeek').textContent=`${fmt(perHour*hoursWeek)} ${outC}`;
  const som=new Date(now.getFullYear(), now.getMonth(), 1); som.setHours(0,0,0,0);
  const hoursMonth=(now-som)/3600000; $('sinceMonth').textContent=`${fmt(perHour*hoursMonth)} ${outC}`;

  const f=(m)=>fmt(perMinute*m)+' '+outC;
  $('perMatch').textContent=f(90); $('perEpisode').textContent=f(45); $('perCoffee').textContent=f(7); $('perShower').textContent=f(8); $('perSong').textContent=f(3.5); $('perPenalty').textContent=f(5);
  $('perTraffic').textContent=fmt(perSecond*90)+' '+outC; $('perEspresso').textContent=fmt(perSecond*30)+' '+outC; $('perDiaper').textContent=f(2); $('perVoice').textContent=f(1); $('perMicrowave').textContent=f(3); $('perBrush').textContent=f(2.5);

  renderOtherCurrencies(totalRaw,inC);
}
function renderOtherCurrencies(totalRaw,inC){
  const list=$('otherList'); list.innerHTML='';
  CURRENCIES.filter(c=>c!==inC).forEach(c=>{
    const val=convert(totalRaw,inC,c); const div=document.createElement('div'); div.className='other';
    div.innerHTML=`<div class="c">${c}</div><div class="n">${fmt(val)}</div>`; list.appendChild(div);
  });
}

/* charts */
function setupCanvas(c){ const dpr=window.devicePixelRatio||1; const w=c.clientWidth,h=c.clientHeight; c.width=Math.floor(w*dpr); c.height=Math.floor(h*dpr); const ctx=c.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0); return ctx; }
function drawValue(ctx,x,y,text){ ctx.fillStyle="#dcdcdc"; ctx.font="12px system-ui"; ctx.textAlign='center'; ctx.fillText(text,x,y-8); }
function lineChart(canvas,data,labels,colorIdx=0){ const ctx=setupCanvas(canvas); const w=canvas.clientWidth,h=canvas.clientHeight,pad=30; ctx.clearRect(0,0,w,h); let min=Math.min(...data),max=Math.max(...data); if(min===max){min-=1;max+=1;} const xstep=(w-2*pad)/Math.max(data.length-1,1); const y=(v)=>{ const t=(v-min)/(max-min); return h-pad - t*(h-2*pad); }; ctx.strokeStyle="#222"; ctx.lineWidth=1; for(let i=0;i<5;i++){ const yy=pad+i*(h-2*pad)/4; ctx.beginPath(); ctx.moveTo(pad,yy); ctx.lineTo(w-pad,yy); ctx.stroke(); } ctx.lineWidth=2.5; ctx.strokeStyle=PAL[colorIdx%PAL.length]; ctx.beginPath(); data.forEach((v,i)=>{ const xx=pad+i*xstep,yy=y(v); if(i===0) ctx.moveTo(xx,yy); else ctx.lineTo(xx,yy); }); ctx.stroke(); ctx.fillStyle=PAL[colorIdx%PAL.length]; data.forEach((v,i)=>{ const xx=pad+i*xstep,yy=y(v); ctx.beginPath(); ctx.arc(xx,yy,3,0,Math.PI*2); ctx.fill(); drawValue(ctx,xx,yy,fmt(v)); }); ctx.fillStyle="#9a9a9a"; ctx.font="12px system-ui"; labels.forEach((lab,i)=>{ const xx=pad+i*xstep; ctx.fillText(lab,xx-12,h-8); }); canvas._points=data.map((v,i)=>({x:pad+i*xstep,y:y(v),v,label:labels[i]})); }
function barChart(canvas,data,labels,colorIdx=2){ const ctx=setupCanvas(canvas); const w=canvas.clientWidth,h=canvas.clientHeight,pad=30; ctx.clearRect(0,0,w,h); const max=Math.max(...data.map(v=>Math.abs(v)),1); const zeroY=h-pad - (0 - (-max))/(2*max)*(h-2*pad); const barW=(w-2*pad)/data.length*0.6; ctx.strokeStyle="#222"; ctx.lineWidth=1; for(let i=0;i<5;i++){ const yy=pad+i*(h-2*pad)/4; ctx.beginPath(); ctx.moveTo(pad,yy); ctx.lineTo(w-pad,yy); ctx.stroke(); } ctx.fillStyle=PAL[colorIdx%PAL.length]; canvas._bars=[]; data.forEach((v,i)=>{ const x=pad+(i+0.2)*(w-2*pad)/data.length; const hgt=(Math.abs(v)/max)*(h-2*pad); const y=v>=0?zeroY-hgt:zeroY; ctx.fillRect(x,y,barW,hgt); drawValue(ctx,x+barW/2,y,(v).toFixed(1)); canvas._bars.push({x,y,w:barW,h:hgt,v,label:labels[i]}); }); ctx.fillStyle="#9a9a9a"; ctx.font="12px system-ui"; labels.forEach((lab,i)=>{ const x=pad+(i+0.2)*(w-2*pad)/data.length; ctx.fillText(lab,x,h-8); }); }
function histChart(canvas,data,bins=6,colorIdx=4){ const ctx=setupCanvas(canvas); const w=canvas.clientWidth,h=canvas.clientHeight,pad=30; ctx.clearRect(0,0,w,h); const min=Math.min(...data),max=Math.max(...data); const width=(max-min)/bins||1; const counts=new Array(bins).fill(0); data.forEach(v=>{ let idx=Math.floor((v-min)/width); if(idx>=bins) idx=bins-1; if(idx<0) idx=0; counts[idx]++; }); const maxC=Math.max(...counts,1); const barW=(w-2*pad)/bins*0.7; ctx.strokeStyle="#222"; for(let i=0;i<5;i++){ const yy=pad+i*(h-2*pad)/4; ctx.beginPath(); ctx.moveTo(pad,yy); ctx.lineTo(w-pad,yy); ctx.stroke(); } ctx.fillStyle=PAL[colorIdx%PAL.length]; canvas._bars=[]; counts.forEach((c,i)=>{ const x=pad+(i+0.15)*(w-2*pad)/bins; const hgt=(c/maxC)*(h-2*pad); const y=h-pad-hgt; ctx.fillRect(x,y,barW,hgt); drawValue(ctx,x+barW/2,y,c); canvas._bars.push({x,y,w:barW,h:hgt,v:c,label:`Bin ${i+1}`}); }); }
function pieChart(canvas,data){ const ctx=setupCanvas(canvas); const w=canvas.clientWidth,h=canvas.clientHeight; ctx.clearRect(0,0,w,h); const cx=w/2,cy=h/2; const r=Math.min(w,h)/2-20; const sum=data.reduce((a,b)=>a+b,0)||1; let a0=-Math.PI/2; canvas._slices=[]; data.forEach((v,i)=>{ const a1=a0+2*Math.PI*(v/sum); ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,a0,a1); ctx.closePath(); ctx.fillStyle=PAL[i%PAL.length]; ctx.fill(); ctx.strokeStyle="#222"; ctx.stroke(); const mid=(a0+a1)/2; const lx=cx+Math.cos(mid)*(r*0.62), ly=cy+Math.sin(mid)*(r*0.62); const pct=((v/sum)*100).toFixed(1)+'%'; drawValue(ctx,lx,ly,pct); canvas._slices.push({a0,a1,value:v,pct}); a0=a1; }); }
function scatterChart(canvas,xs,ys,colorIdx=6){ const ctx=setupCanvas(canvas); const w=canvas.clientWidth,h=canvas.clientHeight,pad=30; ctx.clearRect(0,0,w,h); const xmin=Math.min(...xs),xmax=Math.max(...xs),ymin=Math.min(...ys),ymax=Math.max(...ys); const x=(v)=>pad+((v-xmin)/(xmax-xmin||1))*(w-2*pad), y=(v)=>h-pad-((v-ymin)/(ymax-ymin||1))*(h-2*pad); ctx.strokeStyle="#222"; for(let i=0;i<5;i++){ const yy=pad+i*(h-2*pad)/4; ctx.beginPath(); ctx.moveTo(pad,yy); ctx.lineTo(w-pad,yy); ctx.stroke(); } ctx.fillStyle=PAL[colorIdx%PAL.length]; canvas._points=[]; xs.forEach((vx,i)=>{ const px=x(vx),py=y(ys[i]); ctx.beginPath(); ctx.arc(px,py,3,0,Math.PI*2); ctx.fill(); drawValue(ctx,px,py,ys[i].toFixed(1)); canvas._points.push({x:px,y:py,label:vx,v:ys[i]}); }); }

/* tooltips */
function bindTooltip(canvas,accessor){
  const tt=$('tooltip');
  canvas.addEventListener('mousemove',(e)=>{
    const r=canvas.getBoundingClientRect(); const x=e.clientX-r.left, y=e.clientY-r.top;
    const hit=accessor(canvas,x,y);
    if(hit){ tt.style.display='block'; tt.style.left=e.clientX+'px'; tt.style.top=e.clientY+'px'; tt.innerHTML=`<b>${hit.label}</b><br/>${fmt(hit.v)} ${currentOutC}${hit.suffix?' '+hit.suffix:''}`; }
    else tt.style.display='none';
  });
  canvas.addEventListener('mouseleave',()=>{ $('tooltip').style.display='none'; });
}
function nearPoint(points,x,y){ let m=null,d2=25; points.forEach(p=>{ const dd=(p.x-x)*(p.x-x)+(p.y-y)*(p.y-y); if(dd<d2){m=p;d2=dd;} }); return m; }
function insideBar(bars,x,y){ for(const b of bars){ if(x>=b.x && x<=b.x+b.w && y>=b.y && y<=b.y+b.h) return b; } return null; }
function insideSlice(canvas,x,y){ if(!canvas._slices) return null; const r=Math.min(canvas.clientWidth,canvas.clientHeight)/2-20; const cx=canvas.clientWidth/2, cy=canvas.clientHeight/2; const dx=x-cx, dy=y-cy; const dist=Math.sqrt(dx*dx+dy*dy); if(dist>r) return null; let ang=Math.atan2(dy,dx); if(ang<-Math.PI/2) ang+=2*Math.PI; for(const s of canvas._slices){ if(ang>=s.a0 && ang<=s.a1) return {label:'Slice', v:s.value, suffix:`(${s.pct})`}; } return null; }

/* yearly stats + FX adjustment */
function statsYears(arr){
  const n=arr.length; if(!n) return null;
  const vals=arr.map(o=>o.value);
  const sum=vals.reduce((a,b)=>a+b,0), avg=sum/n;
  const sorted=[...vals].sort((a,b)=>a-b); const median = n%2? sorted[(n-1)/2] : (sorted[n/2-1]+sorted[n/2])/2;
  let bestI=0,worstI=0; for(let i=1;i<n;i++){ if(vals[i]>vals[bestI]) bestI=i; if(vals[i]<vals[worstI]) worstI=i; }
  const variance=vals.reduce((a,b)=>a+(b-avg)*(b-avg),0)/n, sd=Math.sqrt(variance), cv=avg?sd/avg:0;
  const first=vals[0], last=vals[n-1];
  const yearsSpan=Math.max(arr[n-1].year - arr[0].year, n-1);
  const cagr=(yearsSpan>0 && first>0)? Math.pow(last/first,1/yearsSpan)-1 : 0;
  const yoy=vals.map((v,i)=> i===0?0:(vals[i-1]===0?0:(v/vals[i-1]-1)));
  const hitRate=yoy.slice(1).filter(g=>g>0).length/Math.max(n-1,1);
  let peak=vals[0], mdd=0; const ddSeries=[0];
  for(let i=1;i<n;i++){ peak=Math.max(peak,vals[i-1]); const dd=peak? (vals[i]-peak)/peak : 0; mdd=Math.min(mdd,dd); ddSeries.push(dd); }
  const rollVol=[]; for(let i=0;i<n;i++){ const s=vals.slice(Math.max(0,i-2),i+1); const mu=s.reduce((a,b)=>a+b,0)/s.length; const vv=s.reduce((a,b)=>a+(b-mu)*(b-mu),0)/s.length; rollVol.push(Math.sqrt(vv)); }
  return {sum,avg,median,bestI,worstI,cv,cagr,yoy,hitRate,mdd,ddSeries,rollVol,last,first};
}

function drawYearInsights(){
  const inC=$('inCur').value||'USD'; const outC=$('outCur').value||'USD'; currentOutC=outC;
  if(years.length===0){
    ['yYears','yTotal','yAvg','yMedian','yBest','yWorst','yCAGR','yCV','yHit','yMDD','yLastVsAvg','yLastYoY'].forEach(id=>$(id).textContent='â€”');
    ['chartYLine','chartYoY','chartYCum','chartRoll','chartHist','chartPie','chartDD','chartVol','chartScatter','chartLastVs'].forEach(id=>{ const c=$(id); const ctx=setupCanvas(c); ctx.clearRect(0,0,c.clientWidth,c.clientHeight); }); return;
  }
  const series=years.slice().sort((a,b)=>a.year-b.year);
  const egpToday=exchangeRates['EGP'];

  const conv=series.map(o=>{
    if(egpAdjustOn && inC==='EGP'){
      const y=o.year, yRate=egpUsdHistory[y];
      if(yRate && egpToday){
        const usdThen = o.value / yRate;      // EGP_y -> USD at year y
        const egpNow  = usdThen * egpToday;   // USD -> EGP at today's rate
        return {year:y, value: convert(egpNow,'EGP',outC)};
      }
    }
    return {year:o.year, value: convert(o.value,inC,outC)};
  });

  const labels=conv.map(o=>String(o.year)); const vals=conv.map(o=>o.value); const st=statsYears(conv);

  $('yYears').textContent=conv.length;
  $('yTotal').textContent=`${fmt(st.sum)} ${outC}`;
  $('yAvg').textContent=`${fmt(st.avg)} ${outC}`;
  $('yMedian').textContent=`${fmt(st.median)} ${outC}`;
  $('yBest').textContent=`${labels[st.bestI]} Â· ${fmt(vals[st.bestI])} ${outC}`;
  $('yWorst').textContent=`${labels[st.worstI]} Â· ${fmt(vals[st.worstI])} ${outC}`;
  $('yCAGR').textContent=`${(st.cagr*100).toFixed(2)}%`;
  $('yCV').textContent=`${(st.cv*100).toFixed(1)}%`;
  $('yHit').textContent=`${(st.hitRate*100).toFixed(0)}% ${lang==='ar'?'Ø³Ù†ÙŠÙ† Ù†Ù…Ùˆ':'up years'}`;
  $('yMDD').textContent=`${(st.mdd*100).toFixed(1)}%`;
  const lastVsAvg=st.avg? (st.last/st.avg - 1):0; $('yLastVsAvg').textContent=`${(lastVsAvg*100).toFixed(1)}%`;
  const lastYoY=st.yoy.length>1? st.yoy[st.yoy.length-1] : 0; $('yLastYoY').textContent=`${(lastYoY*100).toFixed(1)}%`;

  const c1=$('chartYLine'); lineChart(c1,vals,labels,0); bindTooltip(c1,(cv,x,y)=>nearPoint(cv._points||[],x,y));
  const c2=$('chartYoY'); barChart(c2,st.yoy.map(v=>v*100),labels,2); bindTooltip(c2,(cv,x,y)=>insideBar(cv._bars||[],x,y));
  const cum=[]; vals.reduce((a,b,i)=>cum[i]=a+b,0); const c3=$('chartYCum'); lineChart(c3,cum,labels,1); bindTooltip(c3,(cv,x,y)=>nearPoint(cv._points||[],x,y));
  const roll=[]; for(let i=0;i<vals.length;i++){ const s=vals.slice(Math.max(0,i-2),i+1); roll.push(s.reduce((a,b)=>a+b,0)/s.length); } const c4=$('chartRoll'); lineChart(c4,roll,labels,4); bindTooltip(c4,(cv,x,y)=>nearPoint(cv._points||[],x,y));
  const c5=$('chartHist'); histChart(c5,vals,Math.min(vals.length,6),5); bindTooltip(c5,(cv,x,y)=>insideBar(cv._bars||[],x,y));
  const top=[...vals].sort((a,b)=>b-a).slice(0,5); const rest=Math.max(0,st.sum - top.reduce((a,b)=>a+b,0)); const c6=$('chartPie'); pieChart(c6,[...top,rest]); bindTooltip(c6,(cv,x,y)=>insideSlice(cv,x,y));
  const c7=$('chartDD'); lineChart(c7,st.ddSeries.map(v=>v*100),labels,6); bindTooltip(c7,(cv,x,y)=>nearPoint(cv._points||[],x,y));
  const c8=$('chartVol'); lineChart(c8,st.rollVol,labels,7); bindTooltip(c8,(cv,x,y)=>nearPoint(cv._points||[],x,y));
  const xs=conv.map(o=>o.year), ys=st.yoy.map(v=>v*100); const c9=$('chartScatter'); scatterChart(c9,xs.slice(1),ys.slice(1),8); bindTooltip(c9,(cv,x,y)=>nearPoint(cv._points||[],x,y));
  const c10=$('chartLastVs'); barChart(c10,[lastVsAvg*100],[lang==='ar'?'Ø¢Ø®Ø± Ø³Ù†Ø© Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ù…ØªÙˆØ³Ø·':'Last vs Avg'],9); bindTooltip(c10,(cv,x,y)=>insideBar(cv._bars||[],x,y));
}

/* wiring */
function wire(){
  $('langToggle').addEventListener('click',()=>setLang(lang==='en'?'ar':'en'));

  $('total').addEventListener('input',()=>{ calc(); drawYearInsights(); save(); });
  $('inCur').addEventListener('change',()=>setInputCurrency($('inCur').value));
  $('outCur').addEventListener('change',()=>setDisplayCurrency($('outCur').value));
  $('inCurInsights').addEventListener('change',()=>setInputCurrency($('inCurInsights').value));
  $('outCurInsights').addEventListener('change',()=>setDisplayCurrency($('outCurInsights').value));

  $('openRates').addEventListener('click',()=>{ updateRatesUI(); $('ratesModal').classList.add('open'); });
  $('cancelRates').addEventListener('click',()=>$('ratesModal').classList.remove('open'));
  $('saveRates').addEventListener('click',()=>{ ['EGP','SAR','KWD','AED','EUR','GBP','QAR','OMR','BHD'].forEach(k=>{ exchangeRates[k]=parseFloat($(k.toLowerCase()+'Rate').value)||exchangeRates[k]; }); $('ratesModal').classList.remove('open'); save(); calc(); drawYearInsights(); });

  $('addRow').addEventListener('click',()=>{ const y=years.length? (Math.max(...years.map(r=>r.year))+1):(new Date().getFullYear()); years.push({year:y,value:0}); renderYears(); drawYearInsights(); save(); });
  $('loadSample').addEventListener('click',()=>{ years=[{year:2020,value:8037},{year:2021,value:11325},{year:2022,value:17549},{year:2023,value:13794},{year:2024,value:10892},{year:2025,value:11988},]; renderYears(); drawYearInsights(); save(); });

  // EGP historical modal
  $('egpAdjToggle').checked=egpAdjustOn;
  $('egpAdjToggle').addEventListener('change',(e)=>{ egpAdjustOn=e.target.checked; save(); drawYearInsights(); });

  $('openEgpHist').addEventListener('click',()=>{ buildEgpTable(); $('egpHistModal').classList.add('open'); });
  $('egpClose').addEventListener('click',()=>$('egpHistModal').classList.remove('open'));
  $('egpSave').addEventListener('click',()=>{ readEgpTable(); save(); $('egpHistModal').classList.remove('open'); drawYearInsights(); });

  $('tabDash').addEventListener('click',()=>{ $('tabDash').classList.add('active'); $('tabInsights').classList.remove('active'); $('panelDash').style.display='block'; $('panelInsights').style.display='none'; });
  $('tabInsights').addEventListener('click',()=>{ $('tabInsights').classList.add('active'); $('tabDash').classList.remove('active'); $('panelDash').style.display='none'; $('panelInsights').style.display='block'; drawYearInsights(); });
}
function updateRatesUI(){ ['EGP','SAR','KWD','AED','EUR','GBP','QAR','OMR','BHD'].forEach(k=>{ $(k.toLowerCase()+'Rate').value=exchangeRates[k]; }); }

/* EGP history editor */
function buildEgpTable(){
  const box=$('egpHistTable'); box.innerHTML='';
  const grid=document.createElement('div');
  grid.style.display='grid'; grid.style.gridTemplateColumns='100px 1fr'; grid.style.gap='8px';
  ;['Ø§Ù„Ø³Ù†Ø©','USD/EGP'].forEach(t=>{ const h=document.createElement('div'); h.style.color='#9a9a9a'; h.style.fontSize='12px'; h.textContent=t; grid.appendChild(h); });
  const y0=2000, y1=Math.max(2000,new Date().getFullYear());
  for(let y=y0;y<=y1;y++){
    const yc=document.createElement('div'); yc.textContent=y; yc.style.padding='8px 0';
    const v=document.createElement('input'); v.type='number'; v.step='0.001'; v.min='0'; v.value=(egpUsdHistory[y]??''); v.dataset.year=y;
    grid.appendChild(yc); grid.appendChild(v);
  }
  box.appendChild(grid);
}
function readEgpTable(){
  const inputs=$('egpHistTable').querySelectorAll('input[type="number"]');
  inputs.forEach(inp=>{ const y=+inp.dataset.year, val=parseFloat(inp.value); if(!isNaN(val)&&val>0) egpUsdHistory[y]=val; });
}

/* init */
(function init(){
  ['inCur','outCur','inCurInsights','outCurInsights'].forEach(id=>{
    const el=$(id); if(!el) return; el.innerHTML=CURRENCIES.map(c=>`<option value="${c}">${c}</option>`).join('');
  });
  if(!$('inCur').value) $('inCur').value='USD';
  if(!$('outCur').value) $('outCur').value='USD';
  if($('inCurInsights')&&!$('inCurInsights').value) $('inCurInsights').value=$('inCur').value;
  if($('outCurInsights')&&!$('outCurInsights').value) $('outCurInsights').value=$('outCur').value;

  load(); applyI18n(); wire(); calc(); renderYears(); drawYearInsights();
})();
</script>
</body>
</html>