<!DOCTYPE html><html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Super Earnings Pace â€” Dashboard + Yearly Insights</title>
  <style>
    :root{
      --bg:#0a0a0a; --surface:#0f0f0f; --muted:#9a9a9a; --text:#f6f6f6; --line:#1e1e1e; --accent:#ebebeb; --chip:#151515;
      --c1:#7dd3fc; --c2:#a7f3d0; --c3:#fca5a5; --c4:#fde68a; --c5:#c4b5fd; --c6:#f9a8d4; --c7:#93c5fd; --c8:#6ee7b7; --c9:#fcd34d; --c10:#fdba74;
      --tooltip:#111; --tooltipBorder:#2a2a2a; --sp:14px; --sp-lg:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,ui-sans-serif,-apple-system,Segoe UI,Roboto,system-ui,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1180px;margin:0 auto;padding:20px;display:grid;gap:var(--sp-lg)}
    /* ---------------- Header ---------------- */
    .head{display:flex;gap:12px;align-items:center}
    .title{font-size:18px;font-weight:800}
    .hint{color:var(--muted);font-size:13px}
    .chip{padding:8px 10px;background:var(--chip);border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:12px}
    .right{margin-left:auto}
    #langToggle{padding:10px 12px;border-radius:999px;border:1px solid var(--line);background:#0c0c0c;color:#f6f6f6;font-weight:800;cursor:pointer}

    /* ---------------- Tiny switch + icon btn ---------------- */
    .icon-btn{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#0c0c0c;color:#f6f6f6;font-size:12px;cursor:pointer}
    .icon{width:14px;height:14px;display:inline-block}
    .spin{animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .switch{position:relative;display:inline-block;width:34px;height:18px}
    .switch input{opacity:0;width:0;height:0}
    .switch .slider{position:absolute;inset:0;background:#222;border:1px solid var(--line);border-radius:999px;transition:.18s}
    .switch .slider:before{content:"";position:absolute;height:14px;width:14px;left:2px;top:1px;background:#777;border-radius:50%;transition:.18s}
    .switch input:checked + .slider{background:var(--accent)}
    .switch input:checked + .slider:before{transform:translateX(16px);background:#000}

    /* ---------------- Tabs ---------------- */
    .tabs{display:flex;gap:8px;align-items:center;position:sticky;top:0;z-index:2}
    .tabbtn{padding:10px 14px;border:1px solid var(--line);border-radius:999px;background:#0c0c0c;color:#f6f6f6;cursor:pointer;font-weight:700;transition:transform .12s ease}
    .tabbtn:hover{transform:translateY(-1px)}
    .tabbtn.active{background:var(--accent);color:#000;box-shadow:0 0 0 2px #000 inset}
    .tabspace{background:rgba(10,10,10,.92);border:1px solid var(--line);border-radius:14px;padding:16px;margin-top:6px}

    /* ---------------- Forms & Layout ---------------- */
    .dock{background:rgba(10,10,10,.92);border:1px solid var(--line);border-radius:14px;padding:16px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:var(--sp)}
    .c-2{grid-column:span 2}.c-3{grid-column:span 3}.c-4{grid-column:span 4}.c-5{grid-column:span 5}.c-6{grid-column:span 6}.c-7{grid-column:span 7}.c-8{grid-column:span 8}.c-12{grid-column:span 12}
    @media (max-width:900px){.c-8,.c-7,.c-6,.c-5,.c-4,.c-3,.c-2,.c-12{grid-column:span 12}.grid{gap:16px}}
    label{font-size:11px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,button{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:#0b0b0b;color:#f6f6f6}
    .btn{background:var(--accent);color:#000;border:none;font-weight:700;cursor:pointer}
    .btn:active{transform:translateY(1px)}

    /* ---------------- KPI cards ---------------- */
    .cards{display:grid;grid-template-columns:repeat(6,1fr);gap:var(--sp)}
    @media (max-width:1120px){.cards{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:650px){.cards{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:420px){.cards{grid-template-columns:1fr}}
    .card{background:var(--surface);border:1px solid var(--line);border-radius:16px;padding:16px}
    .k{font-size:10px;letter-spacing:.14em;color:var(--muted);text-transform:uppercase}
    .v{font-size:24px;font-weight:800;margin-top:6px}

    .section{background:var(--surface);border:1px solid var(--line);border-radius:16px;padding:16px;margin-top:var(--sp)}
    .section h2{margin:0 0 8px;font-size:12px;letter-spacing:.12em;color:var(--muted);text-transform:uppercase}
    .bar{height:10px;border:1px solid var(--line);border-radius:10px;background:#121212;overflow:hidden}
    .bar span{display:block;height:100%;width:0;background:var(--accent);transition:width .3s ease}

    .facts{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--sp)}
    @media (max-width:900px){.facts{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:600px){.facts{grid-template-columns:1fr}}
    .fact{background:var(--surface);border:1px solid var(--line);border-radius:14px;padding:12px}
    .fact .t{font-weight:700}
    .fact .d{color:var(--muted);font-size:13px;margin-top:2px}

    .other-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:var(--sp)}
    @media (max-width:900px){.other-grid{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:600px){.other-grid{grid-template-columns:repeat(2,1fr)}}
    .other{background:var(--surface);border:1px solid var(--line);border-radius:12px;padding:12px}
    .other .c{font-size:11px;color:var(--muted)}
    .other .n{font-size:16px;font-weight:700;margin-top:4px}

    /* ---------------- Modal ---------------- */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center}
    .modal.open{display:flex}
    .modal-content{width:min(720px,92vw);background:#0c0c0c;border:1px solid var(--line);border-radius:16px;padding:16px}
    .modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .row{display:grid;grid-template-columns:repeat(5,1fr);gap:var(--sp)}

    /* ---------------- Canvas ---------------- */
    canvas{width:100%;height:280px;border:1px solid var(--line);border-radius:12px;background:#0b0b0b;image-rendering:crisp-edges}
    .mini{height:200px}

    /* ---------------- Tooltip ---------------- */
    .tt{position:fixed;pointer-events:none;background:var(--tooltip);border:1px solid var(--tooltipBorder);padding:8px 10px;border-radius:10px;color:#eee;font-size:12px;transform:translate(-50%,-120%);display:none;white-space:nowrap}

    /* ---------------- Subtle value bump on change ---------------- */
    .bump{animation:bump .28s ease}
    @keyframes bump{0%{transform:scale(1)}40%{transform:scale(1.05)}100%{transform:scale(1)}}

    /* ---------------- RTL overrides ---------------- */
    html.rtl{direction:rtl}
    html.rtl .right{margin-left:0;margin-right:auto}
    html.rtl .tabs{flex-direction:row-reverse}
    html.rtl .grid{direction:rtl}
    html.rtl label, html.rtl .k, html.rtl .hint, html.rtl .t, html.rtl .d {text-align:right}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Clean header (no extra controls) -->
    <div class="head">
      <div class="title" id="t_title">Super Earnings Pace</div>
      <div class="hint" id="t_sub">Manual rates Â· clean pace Â· smart + fun facts</div>
      <span class="right"></span>
      <button id="langToggle" class="chip" title="Switch language">AR / EN</button>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tabbtn active" id="tabDash">Dashboard</button>
      <button class="tabbtn" id="tabInsights">Insights Lab</button>
    </div>

    <!-- ================= DASHBOARD ================= -->
    <div class="tabspace" id="panelDash">
      <div class="dock">
        <div class="grid">
          <div class="c-4">
            <label id="t_total_label">Total earned to date</label>
            <input id="total" type="number" min="0" step="0.01" placeholder="12500.00"/>
          </div>
          <div class="c-3">
            <label id="t_incur">Input currency</label>
            <select id="inCur"></select>
          </div>
          <div class="c-3">
            <label id="t_outcur">Display currency</label>
            <select id="outCur"></select>
          </div>
          <!-- Manual FX editor (no refresh here per request) -->
          <div class="c-2"><label>&nbsp;</label><button class="btn" id="openRates">Rates</button></div>
        </div>
      </div>

      <!-- KPI strip -->
      <div class="cards">
        <div class="card"><div class="k" id="t_persec">Per second</div><div class="v" id="perSec">0.00</div></div>
        <div class="card"><div class="k" id="t_permin">Per minute</div><div class="v" id="perMin">0.00</div></div>
        <div class="card"><div class="k" id="t_perhr">Per hour</div><div class="v" id="perHr">0.00</div></div>
        <div class="card"><div class="k" id="t_perday">Per day</div><div class="v" id="perDay">0.00</div></div>
        <div class="card"><div class="k" id="t_perwk">Per week</div><div class="v" id="perWk">0.00</div></div>
        <div class="card"><div class="k" id="t_permon">Per month (avg)</div><div class="v" id="perMon">0.00</div></div>
      </div>

      <!-- Year progress -->
      <div class="section">
        <h2 id="t_yearprog">Year progress</h2>
        <div style="display:flex;gap:12px;align-items:center">
          <div class="bar" style="flex:1"><span id="yBar"></span></div>
          <span class="chip" id="yPct">0%</span>
          <span class="chip" id="elapsedLabel">day 0 of 365</span>
        </div>
      </div>

      <!-- Other currencies -->
      <div class="section">
        <h2 id="t_othercurr">Earned until now â€” other currencies</h2>
        <div class="other-grid" id="otherList"></div>
      </div>

      <!-- Smart facts -->
      <div class="section">
        <h2 id="t_smartfacts">Smart facts</h2>
        <div class="facts">
          <div class="fact"><div class="t" id="t_proj">Projected year total</div><div class="d" id="proj"></div></div>
          <div class="fact"><div class="t" id="t_sincemid">Earned since midnight</div><div class="d" id="sinceDay"></div></div>
          <div class="fact"><div class="t" id="t_sinceweek">Earned this week</div><div class="d" id="sinceWeek"></div></div>
          <div class="fact"><div class="t" id="t_sincemonth">Earned this month</div><div class="d" id="sinceMonth"></div></div>
        </div>
      </div>

      <details>
        <summary id="t_funfacts">Show fun facts ðŸŽˆ</summary>
        <div class="facts">
          <div class="fact"><div class="t" id="t_match">Per football match (90m)</div><div class="d" id="perMatch"></div></div>
          <div class="fact"><div class="t" id="t_episode">Per Netflix episode (45m)</div><div class="d" id="perEpisode"></div></div>
          <div class="fact"><div class="t" id="t_coffee">Per coffee run (7m)</div><div class="d" id="perCoffee"></div></div>
          <div class="fact"><div class="t" id="t_shower">Per shower (8m)</div><div class="d" id="perShower"></div></div>
          <div class="fact"><div class="t" id="t_song">Per song (3m30s)</div><div class="d" id="perSong"></div></div>
          <div class="fact"><div class="t" id="t_penalty">Penalty shootout (5m)</div><div class="d" id="perPenalty"></div></div>
          <div class="fact"><div class="t" id="t_traffic">Traffic light cycle (90s)</div><div class="d" id="perTraffic"></div></div>
          <div class="fact"><div class="t" id="t_espresso">Espresso shot pull (30s)</div><div class="d" id="perEspresso"></div></div>
          <div class="fact"><div class="t" id="t_diaper">Diaper change (2m)</div><div class="d" id="perDiaper"></div></div>
          <div class="fact"><div class="t" id="t_voice">WhatsApp voice note (1m)</div><div class="d" id="perVoice"></div></div>
          <div class="fact"><div class="t" id="t_micro">Microwave dinner (3m)</div><div class="d" id="perMicrowave"></div></div>
          <div class="fact"><div class="t" id="t_brush">Toothbrushing (2m30s)</div><div class="d" id="perBrush"></div></div>
        </div>
      </details>
    </div>

    <!-- ================= INSIGHTS ================= -->
    <div class="tabspace" id="panelInsights" style="display:none">
      <div class="dock">
        <div class="grid">
          <div class="c-2">
            <label id="t_incur_ins">Input currency</label>
            <select id="inCurInsights"></select>
          </div>
          <div class="c-2">
            <label id="t_outcur_ins">Display currency</label>
            <select id="outCurInsights"></select>
          </div>
          <div class="c-6">
            <label id="t_yearlytot">Yearly totals</label>
            <div id="yearsTable"></div>
          </div>
          <div class="c-1"><label>&nbsp;</label><button class="btn" id="addRow">+ Add</button></div>
          <div class="c-1"><label>&nbsp;</label><button class="btn" id="loadSample">Sample</button></div>
          <div class="c-12">
            <small class="hint" id="t_dataset_hint">Dataset uses the Input currency. All metrics/charts auto-convert to Display currency.</small>
          </div>

          <!-- Small historical EGP switch (Insights-only) -->
          <div class="c-12" style="display:flex;align-items:center;gap:10px">
            <label id="t_histfx_label" class="hint">Use historical USD/EGP (Insights only)</label>
            <label class="switch" title="Use historical USD/EGP for yearly insights">
              <input id="useHistFX" type="checkbox"/>
              <span class="slider"></span>
            </label>
          </div>
        </div>
      </div>

      <div class="cards">
        <div class="card"><div class="k" id="t_yearscovered">Years covered</div><div class="v" id="yYears">â€”</div></div>
        <div class="card"><div class="k" id="t_totalall">Total (all years)</div><div class="v" id="yTotal">â€”</div></div>
        <div class="card"><div class="k" id="t_avgyear">Average / year</div><div class="v" id="yAvg">â€”</div></div>
        <div class="card"><div class="k" id="t_median">Median / year</div><div class="v" id="yMedian">â€”</div></div>
        <div class="card"><div class="k" id="t_bestyear">Best year</div><div class="v" id="yBest">â€”</div></div>
        <div class="card"><div class="k" id="t_worstyear">Worst year</div><div class="v" id="yWorst">â€”</div></div>
        <div class="card"><div class="k" id="t_cagr">CAGR</div><div class="v" id="yCAGR">â€”</div></div>
        <div class="card"><div class="k" id="t_cv">Volatility (Ïƒ/avg)</div><div class="v" id="yCV">â€”</div></div>
        <div class="card"><div class="k" id="t_hit">Growth hit-rate</div><div class="v" id="yHit">â€”</div></div>
        <div class="card"><div class="k" id="t_mdd">Max drawdown</div><div class="v" id="yMDD">â€”</div></div>
        <div class="card"><div class="k" id="t_lastvsavg">Last vs avg</div><div class="v" id="yLastVsAvg">â€”</div></div>
        <div class="card"><div class="k" id="t_lastyoy">Last YoY growth</div><div class="v" id="yLastYoY">â€”</div></div>
      </div>

      <div class="section">
        <h2 id="t_charts">Charts</h2>
        <div class="grid">
          <div class="c-6"><label id="t_c_yline">Yearly totals</label><canvas id="chartYLine" aria-label="Yearly totals line"></canvas><small class="hint" id="t_c_yline_hint">Line chart of yearly totals in Display currency. Hover for details.</small></div>
          <div class="c-6"><label id="t_c_yoy">YoY growth %</label><canvas id="chartYoY" aria-label="YoY growth"></canvas><small class="hint" id="t_c_yoy_hint">Bar chart of year-over-year growth (percentage). Hover to see exact %.</small></div>
          <div class="c-6"><label id="t_c_cum">Cumulative total</label><canvas id="chartYCum" class="mini" aria-label="Cumulative"></canvas><small class="hint" id="t_c_cum_hint">Sum of all years up to each point. Shows compounding progress.</small></div>
          <div class="c-6"><label id="t_c_roll">Rolling 3-yr average</label><canvas id="chartRoll" class="mini" aria-label="Rolling avg"></canvas><small class="hint" id="t_c_roll_hint">Smoother trend line using last 3 years' average.</small></div>
          <div class="c-6"><label id="t_c_hist">Histogram</label><canvas id="chartHist" class="mini" aria-label="Histogram"></canvas><small class="hint" id="t_c_hist_hint">Distribution of yearly totals (how values cluster).</small></div>
          <div class="c-6"><label id="t_c_pie">Top-5 share</label><canvas id="chartPie" class="mini" aria-label="Top 5 share"></canvas><small class="hint" id="t_c_pie_hint">Top 5 years vs the rest.</small></div>
          <div class="c-6"><label id="t_c_dd">Drawdown</label><canvas id="chartDD" class="mini" aria-label="Drawdown"></canvas><small class="hint" id="t_c_dd_hint">Drop from prior peak, % (risk view).</small></div>
          <div class="c-6"><label id="t_c_vol">Rolling volatility</label><canvas id="chartVol" class="mini" aria-label="Volatility"></canvas><small class="hint" id="t_c_vol_hint">Std dev of last 3 years (stability).</small></div>
          <div class="c-6"><label id="t_c_scatter">Growth scatter</label><canvas id="chartScatter" class="mini" aria-label="Growth scatter"></canvas><small class="hint" id="t_c_scatter_hint">Year vs growth %. Closer to top = stronger growth.</small></div>
          <div class="c-6"><label id="t_c_lastvs">Last vs avg bar</label><canvas id="chartLastVs" class="mini" aria-label="Last vs avg"></canvas><small class="hint" id="t_c_lastvs_hint">How the latest year compares to historical average.</small></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tooltip -->
  <div class="tt" id="tooltip" aria-live="polite"></div>

  <!-- Rates modal (manual + API refresh inside only) -->
  <div class="modal" id="ratesModal">
    <div class="modal-content" role="dialog" aria-labelledby="ratesTitle">
      <div class="modal-header">
        <h3 id="ratesTitle">Currency rates (base USD = 1.00)</h3>
        <button class="icon-btn" id="refreshRatesInModal" title="Refresh via API">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.5 9A9 9 0 0 1 21 8"/><path d="M20.5 15A9 9 0 0 1 3 16"/>
          </svg>
        </button>
      </div>
      <div class="row">
        <div><label>USD</label><input id="usdRate" type="number" step="0.01" value="1.00" readonly></div>
        <div><label>EGP</label><input id="egpRate" type="number" step="0.01" value="50.00"></div>
        <div><label>SAR</label><input id="sarRate" type="number" step="0.01" value="3.75"></div>
        <div><label>KWD</label><input id="kwdRate" type="number" step="0.01" value="0.30"></div>
        <div><label>AED</label><input id="aedRate" type="number" step="0.01" value="3.67"></div>
        <div><label>EUR</label><input id="eurRate" type="number" step="0.01" value="0.92"></div>
        <div><label>GBP</label><input id="gbpRate" type="number" step="0.01" value="0.78"></div>
        <div><label>QAR</label><input id="qarRate" type="number" step="0.01" value="3.64"></div>
        <div><label>OMR</label><input id="omrRate" type="number" step="0.001" value="0.384"></div>
        <div><label>BHD</label><input id="bhdRate" type="number" step="0.001" value="0.376"></div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button class="btn" id="cancelRates">Close</button>
        <button class="btn" id="saveRates">Save</button>
      </div>
    </div>
  </div>

  <script>
    // ============================ HELPERS & STATE ============================
    const $ = (id)=>document.getElementById(id);
    const CURRENCIES=['USD','EGP','SAR','KWD','AED','EUR','GBP','QAR','OMR','BHD'];
    const PAL=['#7dd3fc','#a7f3d0','#fca5a5','#fde68a','#c4b5fd','#f9a8d4','#93c5fd','#6ee7b7','#fcd34d','#fdba74'];

    let LOCALE='en-US';
    let nf = new Intl.NumberFormat(LOCALE,{minimumFractionDigits:2,maximumFractionDigits:2});
    const fmt = (n)=> nf.format(Number.isFinite(n)? n : 0);

    // Manual FX (1 USD -> X currency)
    let exchangeRates = {USD:1.00,EGP:50.00,SAR:3.75,KWD:0.30,AED:3.67,EUR:0.92,GBP:0.78,QAR:3.64,OMR:0.384,BHD:0.376};

    const stateKey='super_earnings_tabs_v8';
    let years=[];
    let currentOutC='USD';
    let lang='en';

    // Historical EGP/USD (Insights-only)
    let useHistFX=false;
    const HIST_EGP_USD={
      2000:3.47,2001:3.85,2002:4.28,2003:6.15,2004:6.20,
      2005:5.78,2006:5.74,2007:5.64,2008:5.43,2009:5.60,
      2010:5.62,2011:5.95,2012:6.06,2013:6.87,2014:7.15,
      2015:7.73,2016:12.50,2017:17.80,2018:17.90,2019:16.70,
      2020:15.70,2021:15.70,2022:24.70,2023:30.90,2024:48.00,2025:50.00
    };

    // ================================ i18n ================================
    const i18n={
      en:{
        t_title:'Super Earnings Pace', t_sub:'Manual rates Â· clean pace Â· smart + fun facts',
        tabDash:'Dashboard', tabInsights:'Insights Lab',
        t_total_label:'Total earned to date', t_incur:'Input currency', t_outcur:'Display currency',
        t_persec:'Per second', t_permin:'Per minute', t_perhr:'Per hour', t_perday:'Per day', t_perwk:'Per week', t_permon:'Per month (avg)',
        t_yearprog:'Year progress', t_othercurr:'Earned until now â€” other currencies',
        t_smartfacts:'Smart facts', t_proj:'Projected year total', t_sincemid:'Earned since midnight', t_sinceweek:'Earned this week', t_sincemonth:'Earned this month',
        t_funfacts:'Show fun facts ðŸŽˆ',
        t_match:'Per football match (90m)', t_episode:'Per Netflix episode (45m)', t_coffee:'Per coffee run (7m)', t_shower:'Per shower (8m)', t_song:'Per song (3m30s)', t_penalty:'Penalty shootout (5m)', t_traffic:'Traffic light cycle (90s)', t_espresso:'Espresso shot pull (30s)', t_diaper:'Diaper change (2m)', t_voice:'WhatsApp voice note (1m)', t_micro:'Microwave dinner (3m)', t_brush:'Toothbrushing (2m30s)',
        t_incur_ins:'Input currency', t_outcur_ins:'Display currency', t_yearlytot:'Yearly totals', t_dataset_hint:'Dataset uses the Input currency. All metrics/charts auto-convert to Display currency.',
        t_yearscovered:'Years covered', t_totalall:'Total (all years)', t_avgyear:'Average / year', t_median:'Median / year', t_bestyear:'Best year', t_worstyear:'Worst year', t_cagr:'CAGR', t_cv:'Volatility (Ïƒ/avg)', t_hit:'Growth hit-rate', t_mdd:'Max drawdown', t_lastvsavg:'Last vs avg', t_lastyoy:'Last YoY growth',
        t_charts:'Charts', t_c_yline:'Yearly totals', t_c_yline_hint:'Line chart of yearly totals in Display currency. Hover for details.', t_c_yoy:'YoY growth %', t_c_yoy_hint:'Bar chart of year-over-year growth (percentage). Hover to see exact %.', t_c_cum:'Cumulative total', t_c_cum_hint:'Sum of all years up to each point. Shows compounding progress.', t_c_roll:"Rolling 3-yr average", t_c_roll_hint:"Smoother trend line using last 3 years' average.", t_c_hist:'Histogram', t_c_hist_hint:'Distribution of yearly totals.', t_c_pie:'Top-5 share', t_c_pie_hint:'Top 5 years vs the rest.', t_c_dd:'Drawdown', t_c_dd_hint:'Drop from prior peak, % (risk view).', t_c_vol:'Rolling volatility', t_c_vol_hint:'Std dev of last 3 years (stability).', t_c_scatter:'Growth scatter', t_c_scatter_hint:'Year vs growth %. Closer to top = stronger growth.', t_c_lastvs:'Last vs avg bar', t_c_lastvs_hint:'How the latest year compares to historical average.',
        t_histfx_label:'Use historical USD/EGP (Insights only)'
      },
      ar:{
        t_title:'Ù…Ø¤Ø´Ù‘Ø± ÙˆØªÙŠØ±Ø© Ø§Ù„Ø£Ø±Ø¨Ø§Ø­', t_sub:'Ø£Ø³Ø¹Ø§Ø± ÙŠØ¯ÙˆÙŠÙ‘Ø© Â· Ø¹Ø±Ø¶ Ù†Ø¶ÙŠÙ Â· Ø­Ù‚Ø§ÙŠÙ‚ Ø°ÙƒÙŠÙ‘Ø© ÙˆÙ…Ø³Ù„Ù‘ÙŠØ©',
        tabDash:'Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯', tabInsights:'Ù…Ø¹Ù…Ù„ Ø§Ù„Ø¥Ù†Ø³Ø§ÙŠØªØ³',
        t_total_label:'Ø§Ù„Ù…Ø­ØµÙ‘Ù„ Ù„Ø­Ø¯ Ø¯Ù„ÙˆÙ‚ØªÙŠ', t_incur:'Ø¹Ù…Ù„Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„', t_outcur:'Ø¹Ù…Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶',
        t_persec:'ÙÙŠ Ø§Ù„Ø«Ø§Ù†ÙŠØ©', t_permin:'ÙÙŠ Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©', t_perhr:'ÙÙŠ Ø§Ù„Ø³Ø§Ø¹Ø©', t_perday:'ÙÙŠ Ø§Ù„ÙŠÙˆÙ…', t_perwk:'ÙÙŠ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹', t_permon:'ÙÙŠ Ø§Ù„Ø´Ù‡Ø± (Ù…ØªÙˆØ³Ø·)',
        t_yearprog:'ØªÙ‚Ø¯Ù‘Ù… Ø§Ù„Ø³Ù†Ø©', t_othercurr:'Ø§Ù„Ù…Ø­ØµÙ‘Ù„ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù† â€” Ø¨Ø¹Ù…Ù„Ø§Øª ØªØ§Ù†ÙŠØ©',
        t_smartfacts:'Ø­Ù‚Ø§ÙŠÙ‚ Ø°ÙƒÙŠÙ‘Ø©', t_proj:'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ù„Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø³Ù†Ø©', t_sincemid:'Ù…Ù† Ø¨Ø¹Ø¯ Ù†Øµ Ø§Ù„Ù„ÙŠÙ„', t_sinceweek:'Ù…Ù† Ø£ÙˆÙ„ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹', t_sincemonth:'Ù…Ù† Ø£ÙˆÙ„ Ø§Ù„Ø´Ù‡Ø±',
        t_funfacts:'Ø§Ø¹Ø±Ø¶ Ø­Ù‚Ø§ÙŠÙ‚ Ù„Ø·ÙŠÙØ© ðŸŽˆ',
        t_match:'Ù…Ø§ØªØ´ ÙƒÙˆØ±Ø© (90 Ø¯)', t_episode:'Ø­Ù„Ù‚Ø© Ù†ØªÙÙ„ÙƒØ³ (45 Ø¯)', t_coffee:'Ù…Ø´ÙˆØ§Ø± Ù‚Ù‡ÙˆØ© (7 Ø¯)', t_shower:'Ø¯Ø´ Ø³Ø±ÙŠØ¹ (8 Ø¯)', t_song:'Ø£ØºÙ†ÙŠØ© (3 Ø¯ 30 Ø«)', t_penalty:'Ø¶Ø±Ø¨Ø§Øª ØªØ±Ø¬ÙŠØ­ (5 Ø¯)', t_traffic:'Ø¥Ø´Ø§Ø±Ø© Ù…Ø±ÙˆØ± (90 Ø«)', t_espresso:'Ø´ÙˆØª Ø¥Ø³Ø¨Ø±Ø³Ùˆ (30 Ø«)', t_diaper:'ØªØºÙŠÙŠØ± Ø­ÙÙ‘Ø§Ø¶Ø© (2 Ø¯)', t_voice:'ÙÙˆÙŠØ³ Ù†ÙˆØª (1 Ø¯)', t_micro:'Ø¹Ø´Ø§Ø¡ Ù…Ø§ÙŠÙƒØ±ÙˆÙˆÙŠÙ (3 Ø¯)', t_brush:'Ø³Ù†Ø§Ù† (2 Ø¯ 30 Ø«)',
        t_incur_ins:'Ø¹Ù…Ù„Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„', t_outcur_ins:'Ø¹Ù…Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶', t_yearlytot:'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ù†ÙŠÙ†', t_dataset_hint:'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ù…Ù„Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙˆÙƒÙ„ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª Ø¨ØªØªØ­ÙˆÙ‘Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶.',
        t_yearscovered:'Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ù†ÙŠÙ†', t_totalall:'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (ÙƒÙ„ Ø§Ù„Ø³Ù†ÙŠÙ†)', t_avgyear:'Ù…ØªÙˆØ³Ø·/Ø³Ù†Ø©', t_median:'Ø§Ù„ÙˆØ³ÙŠØ·/Ø³Ù†Ø©', t_bestyear:'Ø£Ø¹Ù„Ù‰ Ø³Ù†Ø©', t_worstyear:'Ø£Ù‚Ù„ Ø³Ù†Ø©', t_cagr:'Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ù…Ùˆ Ø§Ù„Ù…Ø±ÙƒÙ‘Ø¨', t_cv:'ØªØ°Ø¨Ø°Ø¨ (Ïƒ/Ù…ØªÙˆØ³Ø·)', t_hit:'Ø³Ù†ÙŠÙ† Ø·Ù„ÙˆØ¹', t_mdd:'Ø£Ù‚ØµÙ‰ Ù‡Ø¨ÙˆØ·', t_lastvsavg:'Ø§Ù„Ø£Ø®ÙŠØ±Ø© Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ù…ØªÙˆØ³Ø·', t_lastyoy:'Ù†Ù…Ùˆ Ø³Ù†Ø© Ø¨Ø³Ù†Ø©',
        t_charts:'Ø±Ø³ÙˆÙ… Ø¨ÙŠØ§Ù†ÙŠØ©', t_c_yline:'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø§Ù„Ø³Ù†ÙˆÙŠØ©', t_c_yline_hint:'Ø®Ø· Ø¨ÙŠØ¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ù†ÙˆÙŠ Ø¨Ø¹Ù…Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶. Ø­Ø±Ù‘Ùƒ Ù„Ù„ÙØ§ØµÙŠÙ„.', t_c_yoy:'Ù†Ù…Ùˆ % Ø³Ù†Ø© Ø¨Ø³Ù†Ø©', t_c_yoy_hint:'Ø£Ø¹Ù…Ø¯Ø© Ù„Ù„Ù†Ø³Ø¨. Ø­Ø±Ù‘Ùƒ Ù„Ù„Ù…Ø¹Ù„ÙˆÙ…Ø©.', t_c_cum:'Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªØ±Ø§ÙƒÙ…ÙŠ', t_c_cum_hint:'Ø¬Ù…Ø¹ Ø§Ù„Ø³Ù†ÙŠÙ† Ù„Ø­Ø¯ ÙƒÙ„ Ù†Ù‚Ø·Ø©.', t_c_roll:'Ù…ØªÙˆØ³Ø· 3 Ø³Ù†ÙŠÙ†', t_c_roll_hint:'Ø®Ø· Ø£Ù†Ø¹Ù… Ø¨Ù…ØªÙˆØ³Ø· Ø¢Ø®Ø± 3 Ø³Ù†ÙŠÙ†.', t_c_hist:'Ù‡Ø³ØªÙˆØ¬Ø±Ø§Ù…', t_c_hist_hint:'ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª.', t_c_pie:'Ù†Ø³Ø¨Ø© Ø£ÙØ¶Ù„ 5 Ø³Ù†ÙŠÙ†', t_c_pie_hint:'Ø£Ø¹Ù„Ù‰ 5 Ø³Ù†ÙŠÙ† Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ø¨Ø§Ù‚ÙŠ.', t_c_dd:'Ù‡Ø¨ÙˆØ· Ù…Ù† Ø§Ù„Ù‚Ù…Ø©', t_c_dd_hint:'Ø§Ù„ÙØ±Ù‚ Ø¹Ù† Ø£Ø¹Ù„Ù‰ Ù‚ÙŠÙ…Ø© %.', t_c_vol:'ØªØ°Ø¨Ø°Ø¨ Ù…ØªØ­Ø±Ùƒ', t_c_vol_hint:'Ø§Ù†Ø­Ø±Ø§Ù Ù…Ø¹ÙŠØ§Ø±ÙŠ Ù„Ø¢Ø®Ø± 3 Ø³Ù†ÙŠÙ†.', t_c_scatter:'Ø³ÙƒØ§ØªØ± Ø§Ù„Ù†Ù…Ùˆ', t_c_scatter_hint:'Ø§Ù„Ø³Ù†Ø© Ù…Ù‚Ø§Ø¨Ù„ Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ù…Ùˆ.', t_c_lastvs:'Ø§Ù„Ø£Ø®ÙŠØ±Ø© Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ù…ØªÙˆØ³Ø·', t_c_lastvs_hint:'Ù…Ù‚Ø§Ø±Ù†Ø© Ø¢Ø®Ø± Ø³Ù†Ø© Ø¨Ø§Ù„Ù…ØªÙˆØ³Ø·.',
        t_histfx_label:'ÙØ¹Ù‘Ù„ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ Ø¯ÙˆÙ„Ø§Ø±/Ø¬Ù†ÙŠÙ‡ (Ø§Ù„Ø¥Ù†Ø³Ø§ÙŠØªØ³ Ø¨Ø³)'
      }
    };

    function applyI18n(){
      const dict=i18n[lang];
      for(const key in dict){ const el=$(key); if(el) el.textContent=dict[key]; }
      document.documentElement.lang = lang==='ar'?'ar':'en';
      document.documentElement.classList.toggle('rtl', lang==='ar');
      // button label: keep English-only when lang=en
      $('langToggle').textContent = (lang==='ar') ? 'Ø¹Ø±Ø¨ÙŠ / EN' : 'AR / EN';
      LOCALE = lang==='ar'? 'ar-EG' : 'en-US';
      nf = new Intl.NumberFormat(LOCALE,{minimumFractionDigits:2,maximumFractionDigits:2});
    }
    function setLang(next){ lang=next; applyI18n(); renderYears(); drawYearInsights(); save(); }

    // ============================== Persistence ==============================
    function save(){
      const s={ total:$('total').value, inCur:$('inCur').value, outCur:$('outCur').value, years, rates:exchangeRates, lang, useHistFX };
      localStorage.setItem(stateKey, JSON.stringify(s));
    }
    function load(){
      const saved = localStorage.getItem(stateKey); if(!saved) return;
      try{
        const s=JSON.parse(saved);
        ['total','inCur','outCur'].forEach(k=>{ if(s[k]!==undefined && $(k)) $(k).value=s[k]; });
        if(s.rates) exchangeRates={...exchangeRates, ...s.rates};
        if(Array.isArray(s.years)) years=s.years;
        if(s.lang) lang=s.lang;
        if(typeof s.useHistFX==='boolean') useHistFX=s.useHistFX;
      }catch(e){}
    }

    // ============================== Currency (API) ===========================
    async function fetchRates(){
      const btn = $('refreshRatesInModal');
      btn?.querySelector('svg')?.classList.add('spin');
      try{
        const ctrl = new AbortController();
        const t = setTimeout(()=>ctrl.abort(), 8000);
        const res = await fetch('https://open.er-api.com/v6/latest/USD', {signal:ctrl.signal});
        clearTimeout(t);
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        if(data && data.result==='success' && data.rates){
          const r = data.rates;
          const map = {USD:1, EGP:r.EGP, SAR:r.SAR, KWD:r.KWD, AED:r.AED, EUR:r.EUR, GBP:r.GBP, QAR:r.QAR, OMR:r.OMR, BHD:r.BHD};
          Object.keys(map).forEach(k=>{
            const v = map[k];
            if(typeof v==='number' && isFinite(v) && v>0){ exchangeRates[k]=v; }
          });
          updateRatesUI();
          save();
          // recalc twice to ensure UI sync after API & locale swap edge-cases
          calc(); drawYearInsights();
          requestAnimationFrame(()=>{ calc(); drawYearInsights(); });
        } else { throw new Error('Bad payload'); }
      } catch(err){
        $('t_title')?.classList.add('bump'); setTimeout(()=>$('t_title')?.classList.remove('bump'),300);
      } finally{
        btn?.querySelector('svg')?.classList.remove('spin');
      }
    }

    // Year-aware convert (Insights uses historical EGP when enabled)
    function convert(amount, from, to, year){
      if(!amount) return 0;
      const needsEGP = (from==='EGP' || to==='EGP');
      const rateFor = (cur, y) => {
        if(useHistFX && needsEGP && Number.isInteger(y) && cur==='EGP'){
          return HIST_EGP_USD[y] ?? exchangeRates[cur];
        }
        return exchangeRates[cur];
      };
      const usd = amount / (rateFor(from, year) || 1);
      return usd * (rateFor(to, year) || 1);
    }
    function setInputCurrency(cur){ if(CURRENCIES.includes(cur)){ $('inCur').value=cur; $('inCurInsights').value=cur; renderYears(); calc(); drawYearInsights(); save(); } }
    function setDisplayCurrency(cur){ if(CURRENCIES.includes(cur)){ $('outCur').value=cur; $('outCurInsights').value=cur; currentOutC=cur; calc(); drawYearInsights(); save(); } }

    // ============================== Years table ==============================
    function renderYears(){
      const wrap=$('yearsTable'); if(!wrap) return; wrap.innerHTML='';
      const table=document.createElement('div'); table.style.display='grid'; table.style.gridTemplateColumns='140px 1fr 100px'; table.style.gap='12px';
      const head=[ i18n[lang].t_yearlytot, i18n[lang].t_totalall+` (${($('inCur').value||'USD')})`, '' ];
      head.forEach(t=>{ const h=document.createElement('div'); h.style.color='#9a9a9a'; h.style.fontSize='12px'; h.textContent=t; table.appendChild(h); });
      years.forEach((row,idx)=>{
        const y=document.createElement('input'); y.type='number'; y.value=row.year; y.min=1900; y.max=9999; y.step=1;
        const v=document.createElement('input'); v.type='number'; v.step='0.01'; v.min='0'; v.value=row.value;
        const del=document.createElement('button'); del.className='btn'; del.textContent = lang==='ar'? 'Ø­Ø°Ù' : 'Delete';
        y.addEventListener('input',()=>{ years[idx].year=parseInt(y.value||0,10); drawYearInsights(); save(); });
        v.addEventListener('input',()=>{ years[idx].value=parseFloat(v.value||0); drawYearInsights(); save(); });
        del.addEventListener('click',()=>{ years.splice(idx,1); renderYears(); drawYearInsights(); save(); });
        table.appendChild(y); table.appendChild(v); table.appendChild(del);
      });
      wrap.appendChild(table);
    }

    // ============================== Bump helper ==============================
    function setTextBump(id, next){
      const el=$(id); if(!el) return;
      const prev = el.textContent;
      if(prev!==next){ el.textContent=next; el.classList.add('bump'); setTimeout(()=>el.classList.remove('bump'),300); }
    }

    // ============================== Dashboard calc ===========================
    function calc(){
      const totalRaw=parseFloat($('total').value)||0; const inC=$('inCur').value||'USD'; const outC=$('outCur').value||'USD'; currentOutC=outC;
      const now=new Date();
      const start=new Date(now.getFullYear(),0,1,0,0,0,0);
      const endYear=new Date(now.getFullYear(),11,31,23,59,59,999);
      const total = convert(totalRaw, inC, outC); // dashboard = current rates only
      const elapsedMs = now - start; const yearMs = endYear - start;
      const daysInYear = Math.floor((endYear-start)/86400000)+1;

      const elapsedHours = Math.max(elapsedMs/3600000, 1e-9);
      const perHour = total/elapsedHours; const perMinute=perHour/60; const perSecond=perMinute/60; const perDay=perHour*24; const perWeek=perDay*7; const perMonth=perDay*(daysInYear/12);

      setTextBump('perSec', fmt(perSecond));
      setTextBump('perMin', fmt(perMinute));
      setTextBump('perHr',  fmt(perHour));
      setTextBump('perDay', fmt(perDay));
      setTextBump('perWk',  fmt(perWeek));
      setTextBump('perMon', fmt(perMonth));

      const yearPct=Math.min((elapsedMs/yearMs)*100,100);
      $('yBar').style.width=yearPct.toFixed(2)+'%';
      setTextBump('yPct', yearPct.toFixed(1)+'%');
      const dayNumber = Math.floor((now-start)/86400000)+1;
      setTextBump('elapsedLabel', (lang==='ar'?`Ø§Ù„ÙŠÙˆÙ… ${dayNumber} Ù…Ù† ${daysInYear}`:`day ${dayNumber} of ${daysInYear}`));

      setTextBump('proj',        `${fmt(perHour*(daysInYear*24))} ${outC}`);
      const sinceMidnightHours=(now-new Date(now.getFullYear(),now.getMonth(),now.getDate()))/3600000; setTextBump('sinceDay',   `${fmt(perHour*sinceMidnightHours)} ${outC}`);
      const sow=(d=>{ const x=new Date(d); const day=(x.getDay()+6)%7; x.setDate(x.getDate()-day); x.setHours(0,0,0,0); return x; })(now);
      const hoursWeek=(now-sow)/3600000; setTextBump('sinceWeek', `${fmt(perHour*hoursWeek)} ${outC}`);
      const som=new Date(now.getFullYear(), now.getMonth(), 1); som.setHours(0,0,0,0);
      const hoursMonth=(now-som)/3600000; setTextBump('sinceMonth',`${fmt(perHour*hoursMonth)} ${outC}`);

      const perSec   = total/Math.max((now-start)/1000, 1e-6);
      const perMin   = perSec*60; const f = (m)=>fmt(perMin*m)+' '+outC;
      setTextBump('perMatch',f(90)); setTextBump('perEpisode',f(45)); setTextBump('perCoffee',f(7)); setTextBump('perShower',f(8));
      setTextBump('perSong',f(3.5)); setTextBump('perPenalty',f(5));
      setTextBump('perTraffic', fmt(perSec*90)+' '+outC); setTextBump('perEspresso', fmt(perSec*30)+' '+outC);
      setTextBump('perDiaper', f(2)); setTextBump('perVoice', f(1)); setTextBump('perMicrowave', f(3)); setTextBump('perBrush', f(2.5));

      renderOtherCurrencies(totalRaw, inC);
    }

    function renderOtherCurrencies(totalRaw, inC){
      const list=$('otherList'); list.innerHTML='';
      CURRENCIES.filter(c=>c!==inC).forEach(c=>{
        const val = convert(totalRaw, inC, c);
        const div=document.createElement('div');
        div.className='other';
        div.innerHTML=`<div class="c">${c}</div><div class="n">${fmt(val)}</div>`;
        list.appendChild(div);
        setTimeout(()=>div.classList.add('bump'),0); setTimeout(()=>div.classList.remove('bump'),300);
      });
    }

    // ============================== Charts (custom) ==========================
    function setupCanvas(c){ const dpr=window.devicePixelRatio||1; const w=c.clientWidth; const h=c.clientHeight; c.width=Math.floor(w*dpr); c.height=Math.floor(h*dpr); const ctx=c.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0); return ctx; }
    function drawValue(ctx, x, y, text){ ctx.fillStyle="#dcdcdc"; ctx.font="12px system-ui"; ctx.textAlign='center'; ctx.fillText(text, x, y-8); }
    function lineChart(canvas, data, labels, colorIdx=0){
      const ctx=setupCanvas(canvas); const w=canvas.clientWidth, h=canvas.clientHeight, pad=30; ctx.clearRect(0,0,w,h);
      let min=Math.min(...data), max=Math.max(...data); if(min===max){ min-=1; max+=1; }
      const xstep=(w-2*pad)/Math.max(data.length-1,1); const y=(v)=>{ const t=(v-min)/(max-min); return h-pad - t*(h-2*pad); };
      ctx.strokeStyle="#222"; ctx.lineWidth=1; for(let i=0;i<5;i++){ const yy=pad+i*(h-2*pad)/4; ctx.beginPath(); ctx.moveTo(pad,yy); ctx.lineTo(w-pad,yy); ctx.stroke(); }
      ctx.lineWidth=2.5; ctx.strokeStyle=PAL[colorIdx%PAL.length]; ctx.beginPath(); data.forEach((v,i)=>{ const xx=pad+i*xstep; const yy=y(v); if(i===0) ctx.moveTo(xx,yy); else ctx.lineTo(xx,yy); }); ctx.stroke();
      ctx.fillStyle=PAL[colorIdx%PAL.length]; data.forEach((v,i)=>{ const xx=pad+i*xstep; const yy=y(v); ctx.beginPath(); ctx.arc(xx,yy,3,0,Math.PI*2); ctx.fill(); drawValue(ctx, xx, yy, fmt(v)); });
      ctx.fillStyle="#9a9a9a"; ctx.font="12px system-ui"; labels.forEach((lab,i)=>{ const xx=pad+i*xstep; ctx.fillText(lab, xx-12, h-8); });
      canvas._points = data.map((v,i)=>({x:pad+i*xstep, y:y(v), v, label:labels[i]}));
    }
    function barChart(canvas, data, labels, colorIdx=2){
      const ctx=setupCanvas(canvas); const w=canvas.clientWidth, h=canvas.clientHeight, pad=30; ctx.clearRect(0,0,w,h);
      const max=Math.max(...data.map(v=>Math.abs(v)), 1); const zeroY = h-pad - (0 - (-max))/(2*max)*(h-2*pad); const barW=(w-2*pad)/data.length * 0.6;
      ctx.strokeStyle="#222"; ctx.lineWidth=1; for(let i=0;i<5;i++){ const yy=pad+i*(h-2*pad)/4; ctx.beginPath(); ctx.moveTo(pad,yy); ctx.lineTo(w-pad,yy); ctx.stroke(); }
      ctx.fillStyle=PAL[colorIdx%PAL.length]; canvas._bars=[];
      data.forEach((v,i)=>{ const x=pad + (i+0.2)*(w-2*pad)/data.length; const hgt=(Math.abs(v)/max)*(h-2*pad); const y = v>=0? zeroY - hgt : zeroY; ctx.fillRect(x, y, barW, hgt); drawValue(ctx, x+barW/2, y, (v).toFixed(1)); canvas._bars.push({x,y,w:barW,h:hgt,v,label:labels[i]}); });
      ctx.fillStyle="#9a9a9a"; ctx.font="12px system-ui"; labels.forEach((lab,i)=>{ const x=pad + (i+0.2)*(w-2*pad)/data.length; ctx.fillText(lab, x, h-8); });
    }
    function histChart(canvas, data, bins=6, colorIdx=4){ const ctx=setupCanvas(canvas); const w=canvas.clientWidth, h=canvas.clientHeight, pad=30; ctx.clearRect(0,0,w,h); const min=Math.min(...data), max=Math.max(...data); const width=(max-min)/bins || 1; const counts=new Array(bins).fill(0); data.forEach(v=>{ let idx=Math.floor((v-min)/width); if(idx>=bins) idx=bins-1; if(idx<0) idx=0; counts[idx]++; }); const maxC=Math.max(...counts,1); const barW=(w-2*pad)/bins*0.7; ctx.strokeStyle="#222"; for(let i=0;i<5;i++){ const yy=pad+i*(h-2*pad)/4; ctx.beginPath(); ctx.moveTo(pad,yy); ctx.lineTo(w-pad,yy); ctx.stroke(); } ctx.fillStyle=PAL[colorIdx%PAL.length]; canvas._bars=[]; counts.forEach((c,i)=>{ const x=pad + (i+0.15)*(w-2*pad)/bins; const hgt=(c/maxC)*(h-2*pad); const y=h-pad-hgt; ctx.fillRect(x, y, barW, hgt); drawValue(ctx, x+barW/2, y, c); canvas._bars.push({x,y,w:barW,h:hgt,v:c,label:`Bin ${i+1}`}); }); }
    function pieChart(canvas, data){ const ctx=setupCanvas(canvas); const w=canvas.clientWidth, h=canvas.clientHeight; ctx.clearRect(0,0,w,h); const cx=w/2, cy=h/2; const r=Math.min(w,h)/2 - 20; const sum=data.reduce((a,b)=>a+b,0)||1; let a0=-Math.PI/2; canvas._slices=[]; data.forEach((v,i)=>{ const a1=a0 + 2*Math.PI*(v/sum); ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,a0,a1); ctx.closePath(); ctx.fillStyle=PAL[i%PAL.length]; ctx.fill(); ctx.strokeStyle="#222"; ctx.stroke(); const mid=(a0+a1)/2; const lx=cx+Math.cos(mid)*(r*0.62), ly=cy+Math.sin(mid)*(r*0.62); const pct=((v/sum)*100).toFixed(1)+'%'; drawValue(ctx, lx, ly, pct); canvas._slices.push({a0,a1,value:v,pct}); a0=a1; }); }
    function scatterChart(canvas, xs, ys, colorIdx=6){ const ctx=setupCanvas(canvas); const w=canvas.clientWidth, h=canvas.clientHeight, pad=30; ctx.clearRect(0,0,w,h); const xmin=Math.min(...xs), xmax=Math.max(...xs), ymin=Math.min(...ys), ymax=Math.max(...ys); const x=(v)=> pad + ((v-xmin)/(xmax-xmin||1))*(w-2*pad), y=(v)=> h-pad - ((v-ymin)/(ymax-ymin||1))*(h-2*pad); ctx.strokeStyle="#222"; for(let i=0;i<5;i++){ const yy=pad+i*(h-2*pad)/4; ctx.beginPath(); ctx.moveTo(pad,yy); ctx.lineTo(w-pad,yy); ctx.stroke(); } ctx.fillStyle=PAL[colorIdx%PAL.length]; canvas._points=[]; xs.forEach((vx,i)=>{ const px=x(vx), py=y(ys[i]); ctx.beginPath(); ctx.arc(px,py,3,0,Math.PI*2); ctx.fill(); drawValue(ctx, px, py, ys[i].toFixed(1)); canvas._points.push({x:px,y:py,label:vx,v:ys[i]}); }); }
    function bindTooltip(canvas, accessor){ const tt=$('tooltip'); canvas.addEventListener('mousemove', (e)=>{ const r=canvas.getBoundingClientRect(); const x=e.clientX-r.left, y=e.clientY-r.top; const hit=accessor(canvas,x,y); if(hit){ tt.style.display='block'; tt.style.left=e.clientX+'px'; tt.style.top=e.clientY+'px'; tt.innerHTML = `<b>${hit.label}</b><br/>${fmt(hit.v)} ${currentOutC}`; } else { tt.style.display='none'; } }); canvas.addEventListener('mouseleave', ()=>{ $('tooltip').style.display='none'; }); }

    // ============================== Yearly insights ==========================
    function statsYears(arr){
      const n=arr.length; if(!n) return null;
      const vals = arr.map(o=>o.value);
      const sum=vals.reduce((a,b)=>a+b,0);
      const avg=sum/n;
      const sorted=[...vals].sort((a,b)=>a-b);
      const median = n%2? sorted[(n-1)/2] : (sorted[n/2-1]+sorted[n/2])/2;
      let bestI=0, worstI=0; for(let i=1;i<n;i++){ if(vals[i]>vals[bestI]) bestI=i; if(vals[i]<vals[worstI]) worstI=i; }
      const variance = vals.reduce((a,b)=>a+(b-avg)*(b-avg),0)/n; const sd = Math.sqrt(variance); const cv = avg? sd/avg : 0;
      const first = vals[0]; const last = vals[n-1];
      const yearsSpan = Math.max(arr[n-1].year - arr[0].year, n-1);
      const cagr = (yearsSpan>0 && first>0)? Math.pow(last/first, 1/yearsSpan)-1 : 0;
      const yoy = vals.map((v,i)=> i===0? 0 : (vals[i-1]===0? 0 : (v/vals[i-1]-1)) );
      const hitRate = yoy.slice(1).filter(g=>g>0).length / Math.max(n-1,1);
      let peak=vals[0], mdd=0; const ddSeries=[0];
      for(let i=1;i<n;i++){ peak=Math.max(peak, vals[i-1]); const dd = peak? (vals[i]-peak)/peak : 0; mdd = Math.min(mdd, dd); ddSeries.push(dd); }
      const rollVol=[]; for(let i=0;i<n;i++){ const s=vals.slice(Math.max(0,i-2), i+1); const mu=s.reduce((a,b)=>a+b,0)/s.length; const vv=s.reduce((a,b)=>a+(b-mu)*(b-mu),0)/s.length; rollVol.push(Math.sqrt(vv)); }
      return {sum,avg,median,bestI,worstI,cv,cagr,yoy,hitRate,mdd,ddSeries,rollVol,last,first};
    }

    function drawYearInsights(){
      const inC=$('inCur').value||'USD'; const outC=$('outCur').value||'USD'; currentOutC=outC;
      if(years.length===0){
        ['yYears','yTotal','yAvg','yMedian','yBest','yWorst','yCAGR','yCV','yHit','yMDD','yLastVsAvg','yLastYoY'].forEach(id=>$(id).textContent='â€”');
        ['chartYLine','chartYoY','chartYCum','chartRoll','chartHist','chartPie','chartDD','chartVol','chartScatter','chartLastVs'].forEach(id=>{ const c=$(id); const ctx=setupCanvas(c); ctx.clearRect(0,0,c.clientWidth,c.clientHeight); });
        return;
      }
      const series = years.slice().sort((a,b)=>a.year-b.year);
      // year-aware conversion here
      const conv = series.map(o=> ({year:o.year, value: convert(o.value, inC, outC, o.year)}));
      const labels = conv.map(o=>String(o.year));
      const vals = conv.map(o=>o.value);

      const st = statsYears(conv);
      setTextBump('yYears', String(conv.length));
      setTextBump('yTotal', `${fmt(st.sum)} ${outC}`);
      setTextBump('yAvg',   `${fmt(st.avg)} ${outC}`);
      setTextBump('yMedian',`${fmt(st.median)} ${outC}`);
      setTextBump('yBest',  `${labels[st.bestI]} Â· ${fmt(vals[st.bestI])} ${outC}`);
      setTextBump('yWorst', `${labels[st.worstI]} Â· ${fmt(vals[st.worstI])} ${outC}`);
      setTextBump('yCAGR',  `${(st.cagr*100).toFixed(2)}%`);
      setTextBump('yCV',    `${(st.cv*100).toFixed(1)}%`);
      setTextBump('yHit',   `${(st.hitRate*100).toFixed(0)}% ${lang==='ar'?'Ø³Ù†ÙŠÙ† Ø·Ù„ÙˆØ¹':'up years'}`);
      setTextBump('yMDD',   `${(st.mdd*100).toFixed(1)}%`);
      const lastVsAvg = st.avg? (st.last/st.avg - 1) : 0; setTextBump('yLastVsAvg', `${(lastVsAvg*100).toFixed(1)}%`);
      const lastYoY = st.yoy.length>1? st.yoy[st.yoy.length-1] : 0; setTextBump('yLastYoY', `${(lastYoY*100).toFixed(1)}%`);

      const c1=$('chartYLine'); lineChart(c1, vals, labels, 0); bindTooltip(c1,(cv,x,y)=> ({...nearest(cv._points,x,y)}));
      const c2=$('chartYoY'); barChart(c2, st.yoy.map(v=>v*100), labels, 2); bindTooltip(c2,(cv,x,y)=> insideBar(cv._bars||[],x,y));
      const cum=[]; vals.reduce((a,b,i)=> cum[i]=a+b, 0); const c3=$('chartYCum'); lineChart(c3, cum, labels, 1); bindTooltip(c3,(cv,x,y)=> nearest(cv._points,x,y));
      const roll=[]; for(let i=0;i<vals.length;i++){ const s=vals.slice(Math.max(0,i-2), i+1); roll.push(s.reduce((a,b)=>a+b,0)/s.length); } const c4=$('chartRoll'); lineChart(c4, roll, labels, 4); bindTooltip(c4,(cv,x,y)=> nearest(cv._points,x,y));
      const c5=$('chartHist'); histChart(c5, vals, Math.min(vals.length,6), 5); bindTooltip(c5,(cv,x,y)=> insideBar(cv._bars||[],x,y));
      const top=[...vals].sort((a,b)=>b-a).slice(0,5); const rest=Math.max(0, st.sum - top.reduce((a,b)=>a+b,0)); const c6=$('chartPie'); pieChart(c6, [...top, rest]); bindTooltip(c6,(cv,x,y)=> insideSlice(cv,x,y));
      const c7=$('chartDD'); lineChart(c7, st.ddSeries.map(v=>v*100), labels, 6); bindTooltip(c7,(cv,x,y)=> nearest(cv._points,x,y));
      const c8=$('chartVol'); lineChart(c8, st.rollVol, labels, 7); bindTooltip(c8,(cv,x,y)=> nearest(cv._points,x,y));
      const xs = conv.map(o=>o.year); const ys = st.yoy.map(v=>v*100); const c9=$('chartScatter'); scatterChart(c9, xs.slice(1), ys.slice(1), 8); bindTooltip(c9,(cv,x,y)=> nearest(cv._points,x,y));
      const c10=$('chartLastVs'); barChart(c10, [lastVsAvg*100], [lang==='ar'?'Ø§Ù„Ø£Ø®ÙŠØ±Ø© Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ù…ØªÙˆØ³Ø·':'Last vs Avg'], 9); bindTooltip(c10,(cv,x,y)=> insideBar(cv._bars||[],x,y));

      // quick helper
      function nearest(points,x,y){ let m=null,d2=25; (points||[]).forEach(p=>{ const dd=(p.x-x)*(p.x-x)+(p.y-y)*(p.y-y); if(dd<d2){ m=p; d2=dd; } }); return m; }
    }

    // ============================== Wiring & boot ============================
    function wire(){
      $('langToggle').addEventListener('click',()=> setLang(lang==='en'?'ar':'en'));

      const debounce=(fn,ms=120)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}};
      $('total').addEventListener('input', debounce(()=>{ calc(); drawYearInsights(); save(); }));
      $('inCur').addEventListener('change', ()=> setInputCurrency($('inCur').value));
      $('outCur').addEventListener('change', ()=> setDisplayCurrency($('outCur').value));
      $('inCurInsights').addEventListener('change', ()=> setInputCurrency($('inCurInsights').value));
      $('outCurInsights').addEventListener('change', ()=> setDisplayCurrency($('outCurInsights').value));

      $('openRates').addEventListener('click', ()=>{ updateRatesUI(); $('ratesModal').classList.add('open'); });
      $('cancelRates').addEventListener('click', ()=>$('ratesModal').classList.remove('open'));
      $('saveRates').addEventListener('click', ()=>{ ['EGP','SAR','KWD','AED','EUR','GBP','QAR','OMR','BHD'].forEach(k=>{ exchangeRates[k]=parseFloat($(k.toLowerCase()+"Rate").value)||exchangeRates[k]; }); $('ratesModal').classList.remove('open'); save(); calc(); drawYearInsights(); });

      $('refreshRatesInModal').addEventListener('click', fetchRates);

      $('addRow').addEventListener('click', ()=>{ const y = years.length? (Math.max(...years.map(r=>r.year))+1) : (new Date().getFullYear()); years.push({year:y, value:0}); renderYears(); drawYearInsights(); save(); });
      $('loadSample').addEventListener('click', ()=>{ years = [ {year:2020, value:8037}, {year:2021, value:11325}, {year:2022, value:17549}, {year:2023, value:13794}, {year:2024, value:10892}, {year:2025, value:11988}, ]; renderYears(); drawYearInsights(); save(); });

      $('tabDash').addEventListener('click', ()=>{ $('tabDash').classList.add('active'); $('tabInsights').classList.remove('active'); $('panelDash').style.display='block'; $('panelInsights').style.display='none'; });
      $('tabInsights').addEventListener('click', ()=>{ $('tabInsights').classList.add('active'); $('tabDash').classList.remove('active'); $('panelDash').style.display='none'; $('panelInsights').style.display='block'; drawYearInsights(); });

      // Historical toggle (insights-only)
      $('useHistFX')?.addEventListener('change',()=>{
        useHistFX=$('useHistFX').checked;
        save();
        // double-draw to assert correctness after toggling on/off
        drawYearInsights();
        requestAnimationFrame(()=> drawYearInsights());
      });

      window.addEventListener('resize', debounce(()=> drawYearInsights(), 150));
    }

    function updateRatesUI(){ ['EGP','SAR','KWD','AED','EUR','GBP','QAR','OMR','BHD'].forEach(k=>{ $(k.toLowerCase()+"Rate").value = exchangeRates[k]; }); }

    (function init(){
      ['inCur','outCur','inCurInsights','outCurInsights'].forEach(id=>{ const el=$(id); if(!el) return; el.innerHTML = CURRENCIES.map(c=>`<option value="${c}">${c}</option>`).join(''); });
      if(!$('inCur').value) $('inCur').value='USD';
      if(!$('outCur').value) $('outCur').value='USD';
      if($('inCurInsights') && !$('inCurInsights').value) $('inCurInsights').value=$('inCur').value;
      if($('outCurInsights') && !$('outCurInsights').value) $('outCurInsights').value=$('outCur').value;

      load();
      applyI18n();
      wire();
      $('useHistFX') && ($('useHistFX').checked = !!useHistFX);
      calc();
      renderYears();
      drawYearInsights();
    })();
  </script>
</body>
</html>
